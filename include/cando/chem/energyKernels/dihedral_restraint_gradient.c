void dihedral_restraint_gradient(double kdh, double phi0, size_t i3x1, size_t i3x2, size_t i3x3, size_t i3x4, double* position, double* energy_accumulate, double* force, double* hessian, double* dvec, double* hdvec) {
  constexpr size_t PositionSize = 12;
  /* !BASE */
  double cosphi;
  double cse_p1_t10_g53028;
  double cse_p1_t11_g53029;
  double cse_p1_t12_g53030;
  double cse_p1_t13_g53031;
  double cse_p1_t14_g53032;
  double cse_p1_t15_g53033;
  double cse_p1_t16_g53034;
  double cse_p1_t17_g53035;
  double cse_p1_t18_g53036;
  double cse_p1_t19_g53037;
  double cse_p1_t1_g53019;
  double cse_p1_t1_g53066;
  double cse_p1_t1_g53067;
  double cse_p1_t1_g53068;
  double cse_p1_t1_g53069;
  double cse_p1_t1_g53070;
  double cse_p1_t1_g53071;
  double cse_p1_t1_g53072;
  double cse_p1_t1_g53073;
  double cse_p1_t1_g53074;
  double cse_p1_t1_g53075;
  double cse_p1_t20_g53038;
  double cse_p1_t21_g53039;
  double cse_p1_t22_g53040;
  double cse_p1_t23_g53041;
  double cse_p1_t24_g53042;
  double cse_p1_t25_g53043;
  double cse_p1_t26_g53044;
  double cse_p1_t27_g53045;
  double cse_p1_t28_g53046;
  double cse_p1_t29_g53047;
  double cse_p1_t2_g53020;
  double cse_p1_t30_g53048;
  double cse_p1_t31_g53049;
  double cse_p1_t32_g53050;
  double cse_p1_t33_g53051;
  double cse_p1_t34_g53052;
  double cse_p1_t35_g53053;
  double cse_p1_t36_g53054;
  double cse_p1_t37_g53055;
  double cse_p1_t38_g53056;
  double cse_p1_t39_g53057;
  double cse_p1_t3_g53021;
  double cse_p1_t40_g53058;
  double cse_p1_t41_g53059;
  double cse_p1_t42_g53060;
  double cse_p1_t43_g53061;
  double cse_p1_t44_g53062;
  double cse_p1_t45_g53063;
  double cse_p1_t46_g53064;
  double cse_p1_t47_g53065;
  double cse_p1_t4_g53022;
  double cse_p1_t5_g53023;
  double cse_p1_t6_g53024;
  double cse_p1_t7_g53025;
  double cse_p1_t8_g53026;
  double cse_p1_t9_g53027;
  double cse_p2_t1_g53076;
  double cse_p2_t1_g53077;
  double cse_p2_t1_g53078;
  double cse_p2_t1_g53079;
  double cse_p2_t1_g53080;
  double cse_p51_t1_g53081;
  double cse_p51_t1_g53082;
  double deltaphi;
  double dot_n1n2;
  double dx12;
  double dx23;
  double dx34;
  double dy12;
  double dy23;
  double dy34;
  double dz12;
  double dz23;
  double dz34;
  double energy;
  double g_x1;
  double g_x2;
  double g_x3;
  double g_x4;
  double g_y1;
  double g_y2;
  double g_y3;
  double g_y4;
  double g_z1;
  double g_z2;
  double g_z3;
  double g_z4;
  double inv_n1n2;
  double n1;
  double n1x;
  double n1y;
  double n1z;
  double n1_2;
  double n2;
  double n2x;
  double n2y;
  double n2z;
  double n2_2;
  double phi;
  double r12;
  double r12_2;
  double r23;
  double r23_2;
  double r34;
  double r34_2;
  DOUBLE x1 = position[i3x1 + 0];
  DOUBLE y1 = position[i3x1 + 1];
  DOUBLE z1 = position[i3x1 + 2];
  DOUBLE x2 = position[i3x2 + 0];
  DOUBLE y2 = position[i3x2 + 1];
  DOUBLE z2 = position[i3x2 + 2];
  DOUBLE x3 = position[i3x3 + 0];
  DOUBLE y3 = position[i3x3 + 1];
  DOUBLE z3 = position[i3x3 + 2];
  DOUBLE x4 = position[i3x4 + 0];
  DOUBLE y4 = position[i3x4 + 1];
  DOUBLE z4 = position[i3x4 + 2];
  {
    /* !BASE */
    dx12 = (x2 + (-(x1)));
    cse_p1_t34_g53052 = (-(dx12));
    dy12 = (y2 + (-(y1)));
    cse_p1_t37_g53055 = (-(dy12));
    dz12 = (z2 + (-(z1)));
    cse_p1_t40_g53058 = (-(dz12));
    dx23 = (x3 + (-(x2)));
    cse_p1_t20_g53038 = (cse_p1_t34_g53052 + (-(dx23)));
    cse_p1_t27_g53045 = (dx12 + dx23);
    cse_p1_t35_g53053 = (-(dx23));
    dy23 = (y3 + (-(y2)));
    cse_p1_t22_g53040 = (cse_p1_t37_g53055 + (-(dy23)));
    cse_p1_t29_g53047 = (dy12 + dy23);
    cse_p1_t38_g53056 = (-(dy23));
    dz23 = (z3 + (-(z2)));
    cse_p1_t24_g53042 = (cse_p1_t40_g53058 + (-(dz23)));
    cse_p1_t31_g53049 = (dz12 + dz23);
    cse_p1_t41_g53059 = (-(dz23));
    dx34 = (x4 + (-(x3)));
    cse_p1_t21_g53039 = (cse_p1_t35_g53053 + (-(dx34)));
    cse_p1_t28_g53046 = (dx23 + dx34);
    cse_p1_t36_g53054 = (-(dx34));
    dy34 = (y4 + (-(y3)));
    cse_p1_t23_g53041 = (cse_p1_t38_g53056 + (-(dy34)));
    cse_p1_t30_g53048 = (dy23 + dy34);
    cse_p1_t39_g53057 = (-(dy34));
    dz34 = (z4 + (-(z3)));
    cse_p1_t25_g53043 = (cse_p1_t41_g53059 + (-(dz34)));
    cse_p1_t32_g53050 = (dz23 + dz34);
    cse_p1_t42_g53060 = (-(dz34));
    r12_2 = ((dx12 * dx12) + (dy12 * dy12) + (dz12 * dz12));
    r23_2 = ((dx23 * dx23) + (dy23 * dy23) + (dz23 * dz23));
    r34_2 = ((dx34 * dx34) + (dy34 * dy34) + (dz34 * dz34));
    r12 = sqrt(r12_2);
    r23 = sqrt(r23_2);
    r34 = sqrt(r34_2);
    n1x = ((dy12 * dz23) + (-((dy23 * dz12))));
    cse_p1_t5_g53023 = (dy12 * n1x);
    cse_p1_t6_g53024 = (dy23 * n1x);
    cse_p1_t14_g53032 = (cse_p1_t31_g53049 * n1x);
    n1y = ((dx23 * dz12) + (-((dx12 * dz23))));
    cse_p1_t9_g53027 = (dz12 * n1y);
    cse_p1_t10_g53028 = (dz23 * n1y);
    cse_p1_t15_g53033 = (cse_p1_t27_g53045 * n1y);
    n1z = ((dx12 * dy23) + (-((dx23 * dy12))));
    cse_p1_t1_g53019 = (dx12 * n1z);
    cse_p1_t2_g53020 = (dx23 * n1z);
    cse_p1_t16_g53034 = (cse_p1_t29_g53047 * n1z);
    n2x = ((dy23 * dz34) + (-((dy34 * dz23))));
    cse_p1_t7_g53025 = (dy23 * n2x);
    cse_p1_t8_g53026 = (dy34 * n2x);
    cse_p1_t17_g53035 = (cse_p1_t32_g53050 * n2x);
    n2y = ((dx34 * dz23) + (-((dx23 * dz34))));
    cse_p1_t11_g53029 = (dz23 * n2y);
    cse_p1_t12_g53030 = (dz34 * n2y);
    cse_p1_t18_g53036 = (cse_p1_t28_g53046 * n2y);
    n2z = ((dx23 * dy34) + (-((dx34 * dy23))));
    cse_p1_t3_g53021 = (dx23 * n2z);
    cse_p1_t4_g53022 = (dx34 * n2z);
    cse_p1_t19_g53037 = (cse_p1_t30_g53048 * n2z);
    n1_2 = ((n1x * n1x) + (n1y * n1y) + (n1z * n1z));
    cse_p1_t46_g53064 = pow(n1_2, -0.50000000000000000    );
    n2_2 = ((n2x * n2x) + (n2y * n2y) + (n2z * n2z));
    cse_p1_t47_g53065 = pow(n2_2, -0.50000000000000000    );
    n1 = sqrt(n1_2);
    n2 = sqrt(n2_2);
    cse_p1_t13_g53031 = (n1 * n2);
    cse_p1_t43_g53061 = pow(cse_p1_t13_g53031, -2);
    dot_n1n2 = ((n1x * n2x) + (n1y * n2y) + (n1z * n2z));
    inv_n1n2 = pow(cse_p1_t13_g53031, -1);
    cosphi = (dot_n1n2 * inv_n1n2);
    cse_p1_t26_g53044 = (1.0000000000000000     + (-(((cosphi) * (cosphi)))));
    cse_p1_t33_g53051 = (-(((cosphi) * (cosphi))));
    cse_p1_t44_g53062 = pow(cse_p1_t26_g53044, -0.50000000000000000    );
    cse_p1_t45_g53063 = ((cosphi) * (cosphi));
    phi = acos(cosphi);
    deltaphi = (phi + (-(phi0)));
    cse_p2_t1_g53080 = (deltaphi * kdh);
    energy = (cse_p2_t1_g53080 * deltaphi);
    *energy_accumulate += energy;
    cse_p1_t1_g53066 = (2.0000000000000000     * cse_p2_t1_g53080);
    cse_p1_t1_g53067 = (cse_p1_t46_g53064 * n2);
    cse_p51_t1_g53082 = (cse_p1_t43_g53061 * dot_n1n2);
    cse_p1_t1_g53069 = (-0.50000000000000000     * cse_p51_t1_g53082);
    cse_p1_t1_g53074 = (2.0000000000000000     * n1z);
    cse_p2_t1_g53078 = (cse_p1_t1_g53067 * cse_p1_t1_g53069);
    cse_p51_t1_g53081 = (cse_p1_t1_g53066 * cse_p1_t44_g53062);
    g_x1 = (-((cse_p51_t1_g53081 * ((cse_p2_t1_g53078 * (cse_p1_t10_g53028 + cse_p1_t10_g53028 + (cse_p1_t1_g53074 * cse_p1_t38_g53056))) + (inv_n1n2 * (cse_p1_t11_g53029 + (cse_p1_t38_g53056 * n2z)))))));
    KernelGradientAcc(i3x1, 0, g_x1);
    cse_p1_t1_g53072 = (2.0000000000000000     * n1x);
    g_y1 = (-((cse_p51_t1_g53081 * ((cse_p2_t1_g53078 * (cse_p1_t2_g53020 + cse_p1_t2_g53020 + (cse_p1_t1_g53072 * cse_p1_t41_g53059))) + (inv_n1n2 * (cse_p1_t3_g53021 + (cse_p1_t41_g53059 * n2x)))))));
    KernelGradientAcc(i3x1, 1, g_y1);
    cse_p1_t1_g53073 = (2.0000000000000000     * n1y);
    g_z1 = (-((cse_p51_t1_g53081 * ((cse_p2_t1_g53078 * (cse_p1_t6_g53024 + cse_p1_t6_g53024 + (cse_p1_t1_g53073 * cse_p1_t35_g53053))) + (inv_n1n2 * (cse_p1_t7_g53025 + (cse_p1_t35_g53053 * n2y)))))));
    KernelGradientAcc(i3x1, 2, g_z1);
    cse_p1_t1_g53068 = (cse_p1_t47_g53065 * n1);
    cse_p1_t1_g53070 = (0.50000000000000000     * cse_p1_t1_g53067);
    cse_p1_t1_g53071 = (0.50000000000000000     * cse_p1_t1_g53068);
    cse_p2_t1_g53077 = (2.0000000000000000     * n2z);
    g_x2 = (-((cse_p51_t1_g53081 * ((inv_n1n2 * ((cse_p1_t24_g53042 * n2y) + (cse_p1_t29_g53047 * n2z) + (cse_p1_t39_g53057 * n1z) + (dz34 * n1y))) + (-((cse_p51_t1_g53082 * ((cse_p1_t1_g53070 * (cse_p1_t16_g53034 + cse_p1_t16_g53034 + (cse_p1_t1_g53073 * cse_p1_t24_g53042))) + (cse_p1_t1_g53071 * (cse_p1_t12_g53030 + cse_p1_t12_g53030 + (cse_p1_t39_g53057 * cse_p2_t1_g53077)))))))))));
    KernelGradientAcc(i3x2, 0, g_x2);
    cse_p1_t1_g53075 = (2.0000000000000000     * n2x);
    g_y2 = (-((cse_p51_t1_g53081 * ((inv_n1n2 * ((cse_p1_t20_g53038 * n2z) + (cse_p1_t31_g53049 * n2x) + (cse_p1_t42_g53060 * n1x) + (dx34 * n1z))) + (-((cse_p51_t1_g53082 * ((cse_p1_t1_g53070 * (cse_p1_t14_g53032 + cse_p1_t14_g53032 + (cse_p1_t1_g53074 * cse_p1_t20_g53038))) + (cse_p1_t1_g53071 * (cse_p1_t4_g53022 + cse_p1_t4_g53022 + (cse_p1_t1_g53075 * cse_p1_t42_g53060)))))))))));
    KernelGradientAcc(i3x2, 1, g_y2);
    cse_p2_t1_g53076 = (2.0000000000000000     * n2y);
    g_z2 = (-((cse_p51_t1_g53081 * ((inv_n1n2 * ((cse_p1_t22_g53040 * n2x) + (cse_p1_t27_g53045 * n2y) + (cse_p1_t36_g53054 * n1y) + (dy34 * n1x))) + (-((cse_p51_t1_g53082 * ((cse_p1_t1_g53070 * (cse_p1_t15_g53033 + cse_p1_t15_g53033 + (cse_p1_t1_g53072 * cse_p1_t22_g53040))) + (cse_p1_t1_g53071 * (cse_p1_t8_g53026 + cse_p1_t8_g53026 + (cse_p1_t36_g53054 * cse_p2_t1_g53076)))))))))));
    KernelGradientAcc(i3x2, 2, g_z2);
    g_x3 = (-((cse_p51_t1_g53081 * ((inv_n1n2 * ((cse_p1_t25_g53043 * n1y) + (cse_p1_t30_g53048 * n1z) + (cse_p1_t37_g53055 * n2z) + (dz12 * n2y))) + (-((cse_p51_t1_g53082 * ((cse_p1_t1_g53070 * (cse_p1_t9_g53027 + cse_p1_t9_g53027 + (cse_p1_t1_g53074 * cse_p1_t37_g53055))) + (cse_p1_t1_g53071 * (cse_p1_t19_g53037 + cse_p1_t19_g53037 + (cse_p1_t25_g53043 * cse_p2_t1_g53076)))))))))));
    KernelGradientAcc(i3x3, 0, g_x3);
    g_y3 = (-((cse_p51_t1_g53081 * ((inv_n1n2 * ((cse_p1_t21_g53039 * n1z) + (cse_p1_t32_g53050 * n1x) + (cse_p1_t40_g53058 * n2x) + (dx12 * n2z))) + (-((cse_p51_t1_g53082 * ((cse_p1_t1_g53070 * (cse_p1_t1_g53019 + cse_p1_t1_g53019 + (cse_p1_t1_g53072 * cse_p1_t40_g53058))) + (cse_p1_t1_g53071 * (cse_p1_t17_g53035 + cse_p1_t17_g53035 + (cse_p1_t21_g53039 * cse_p2_t1_g53077)))))))))));
    KernelGradientAcc(i3x3, 1, g_y3);
    g_z3 = (-((cse_p51_t1_g53081 * ((inv_n1n2 * ((cse_p1_t23_g53041 * n1x) + (cse_p1_t28_g53046 * n1y) + (cse_p1_t34_g53052 * n2y) + (dy12 * n2x))) + (-((cse_p51_t1_g53082 * ((cse_p1_t1_g53070 * (cse_p1_t5_g53023 + cse_p1_t5_g53023 + (cse_p1_t1_g53073 * cse_p1_t34_g53052))) + (cse_p1_t1_g53071 * (cse_p1_t18_g53036 + cse_p1_t18_g53036 + (cse_p1_t1_g53075 * cse_p1_t23_g53041)))))))))));
    KernelGradientAcc(i3x3, 2, g_z3);
    cse_p2_t1_g53079 = (cse_p1_t1_g53068 * cse_p1_t1_g53069);
    g_x4 = (-((cse_p51_t1_g53081 * ((cse_p2_t1_g53079 * (cse_p1_t11_g53029 + cse_p1_t11_g53029 + (cse_p1_t38_g53056 * cse_p2_t1_g53077))) + (inv_n1n2 * (cse_p1_t10_g53028 + (cse_p1_t38_g53056 * n1z)))))));
    KernelGradientAcc(i3x4, 0, g_x4);
    g_y4 = (-((cse_p51_t1_g53081 * ((cse_p2_t1_g53079 * (cse_p1_t3_g53021 + cse_p1_t3_g53021 + (cse_p1_t1_g53075 * cse_p1_t41_g53059))) + (inv_n1n2 * (cse_p1_t2_g53020 + (cse_p1_t41_g53059 * n1x)))))));
    KernelGradientAcc(i3x4, 1, g_y4);
    g_z4 = (-((cse_p51_t1_g53081 * ((cse_p2_t1_g53079 * (cse_p1_t7_g53025 + cse_p1_t7_g53025 + (cse_p1_t35_g53053 * cse_p2_t1_g53076))) + (inv_n1n2 * (cse_p1_t6_g53024 + (cse_p1_t35_g53053 * n1y)))))));
    KernelGradientAcc(i3x4, 2, g_z4);
  }
}
void dihedral_restraint_gradient_fd(double kdh, double phi0, size_t i3x1, size_t i3x2, size_t i3x3, size_t i3x4, double* position, double* energy_accumulate, double* force, double* hessian, double* dvec, double* hdvec)
{
  constexpr size_t PositionSize = 12;
  const double h = 1.0e-5;
  const double inv2h = 1.0/(2.0*h);
  double e0 = 0.0;
  dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e0, 0, 0, 0, 0);
  if (energy_accumulate) { *energy_accumulate += e0; }
  {
    double saved = position[i3x1 + 0];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x1 + 0] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x1 + 0] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x1 + 0] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x1, 0, d);
  }
  {
    double saved = position[i3x1 + 1];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x1 + 1] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x1 + 1] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x1 + 1] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x1, 1, d);
  }
  {
    double saved = position[i3x1 + 2];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x1 + 2] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x1 + 2] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x1 + 2] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x1, 2, d);
  }
  {
    double saved = position[i3x2 + 0];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x2 + 0] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x2 + 0] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x2 + 0] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x2, 0, d);
  }
  {
    double saved = position[i3x2 + 1];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x2 + 1] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x2 + 1] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x2 + 1] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x2, 1, d);
  }
  {
    double saved = position[i3x2 + 2];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x2 + 2] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x2 + 2] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x2 + 2] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x2, 2, d);
  }
  {
    double saved = position[i3x3 + 0];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x3 + 0] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x3 + 0] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x3 + 0] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x3, 0, d);
  }
  {
    double saved = position[i3x3 + 1];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x3 + 1] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x3 + 1] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x3 + 1] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x3, 1, d);
  }
  {
    double saved = position[i3x3 + 2];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x3 + 2] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x3 + 2] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x3 + 2] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x3, 2, d);
  }
  {
    double saved = position[i3x4 + 0];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x4 + 0] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x4 + 0] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x4 + 0] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x4, 0, d);
  }
  {
    double saved = position[i3x4 + 1];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x4 + 1] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x4 + 1] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x4 + 1] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x4, 1, d);
  }
  {
    double saved = position[i3x4 + 2];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x4 + 2] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x4 + 2] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x4 + 2] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x4, 2, d);
  }
}

