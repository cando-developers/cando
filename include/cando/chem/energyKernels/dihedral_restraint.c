template <typename HESSIAN>
struct Dihedral_Restraint {
  static constexpr size_t PositionSize = 12;
void energy(double kdh, double phi0, size_t i3x1, size_t i3x2, size_t i3x3, size_t i3x4, double* position, double* energy_accumulate, double* force, HESSIAN hessian, double* dvec, double* hdvec) {
  /* !BASE */
  double cosphi;
  double deltaphi;
  double dot_n1n2;
  double dx12;
  double dx23;
  double dx34;
  double dy12;
  double dy23;
  double dy34;
  double dz12;
  double dz23;
  double dz34;
  double energy;
  double inv_n1n2;
  double n1;
  double n1x;
  double n1y;
  double n1z;
  double n1_2;
  double n2;
  double n2x;
  double n2y;
  double n2z;
  double n2_2;
  double phi;
  double r12;
  double r12_2;
  double r23;
  double r23_2;
  double r34;
  double r34_2;
  DOUBLE x1 = position[i3x1 + 0];
  DOUBLE y1 = position[i3x1 + 1];
  DOUBLE z1 = position[i3x1 + 2];
  DOUBLE x2 = position[i3x2 + 0];
  DOUBLE y2 = position[i3x2 + 1];
  DOUBLE z2 = position[i3x2 + 2];
  DOUBLE x3 = position[i3x3 + 0];
  DOUBLE y3 = position[i3x3 + 1];
  DOUBLE z3 = position[i3x3 + 2];
  DOUBLE x4 = position[i3x4 + 0];
  DOUBLE y4 = position[i3x4 + 1];
  DOUBLE z4 = position[i3x4 + 2];
  {
    /* !BASE */
    dx12 = (x2 + (-(x1)));
    dy12 = (y2 + (-(y1)));
    dz12 = (z2 + (-(z1)));
    dx23 = (x3 + (-(x2)));
    dy23 = (y3 + (-(y2)));
    dz23 = (z3 + (-(z2)));
    dx34 = (x4 + (-(x3)));
    dy34 = (y4 + (-(y3)));
    dz34 = (z4 + (-(z3)));
    r12_2 = ((dx12 * dx12) + (dy12 * dy12) + (dz12 * dz12));
    r23_2 = ((dx23 * dx23) + (dy23 * dy23) + (dz23 * dz23));
    r34_2 = ((dx34 * dx34) + (dy34 * dy34) + (dz34 * dz34));
    r12 = sqrt(r12_2);
    r23 = sqrt(r23_2);
    r34 = sqrt(r34_2);
    n1x = ((dy12 * dz23) + (-((dy23 * dz12))));
    n1y = ((dx23 * dz12) + (-((dx12 * dz23))));
    n1z = ((dx12 * dy23) + (-((dx23 * dy12))));
    n2x = ((dy23 * dz34) + (-((dy34 * dz23))));
    n2y = ((dx34 * dz23) + (-((dx23 * dz34))));
    n2z = ((dx23 * dy34) + (-((dx34 * dy23))));
    n1_2 = ((n1x * n1x) + (n1y * n1y) + (n1z * n1z));
    n2_2 = ((n2x * n2x) + (n2y * n2y) + (n2z * n2z));
    n1 = sqrt(n1_2);
    n2 = sqrt(n2_2);
    dot_n1n2 = ((n1x * n2x) + (n1y * n2y) + (n1z * n2z));
    inv_n1n2 = (1.0 / ((n1 * n2)));
    cosphi = (dot_n1n2 * inv_n1n2);
    phi = acos(cosphi);
    deltaphi = (phi + (-(phi0)));
    energy = (deltaphi * deltaphi * kdh);
    *energy_accumulate += energy;
  }
}
void energy_fd(double kdh, double phi0, size_t i3x1, size_t i3x2, size_t i3x3, size_t i3x4, double* position, double* energy_accumulate, double* force, HESSIAN hessian, double* dvec, double* hdvec)
{
  energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, energy_accumulate, force, hessian, dvec, hdvec);
}

void gradient(double kdh, double phi0, size_t i3x1, size_t i3x2, size_t i3x3, size_t i3x4, double* position, double* energy_accumulate, double* force, HESSIAN hessian, double* dvec, double* hdvec) {
  /* !BASE */
  double cosphi;
  double cse_p1_t10_g88546;
  double cse_p1_t11_g88547;
  double cse_p1_t12_g88548;
  double cse_p1_t13_g88549;
  double cse_p1_t14_g88550;
  double cse_p1_t15_g88551;
  double cse_p1_t16_g88552;
  double cse_p1_t17_g88553;
  double cse_p1_t18_g88554;
  double cse_p1_t19_g88555;
  double cse_p1_t1_g88537;
  double cse_p1_t1_g88584;
  double cse_p1_t1_g88585;
  double cse_p1_t1_g88586;
  double cse_p1_t1_g88587;
  double cse_p1_t1_g88588;
  double cse_p1_t1_g88589;
  double cse_p1_t1_g88590;
  double cse_p1_t1_g88591;
  double cse_p1_t1_g88592;
  double cse_p1_t1_g88593;
  double cse_p1_t20_g88556;
  double cse_p1_t21_g88557;
  double cse_p1_t22_g88558;
  double cse_p1_t23_g88559;
  double cse_p1_t24_g88560;
  double cse_p1_t25_g88561;
  double cse_p1_t26_g88562;
  double cse_p1_t27_g88563;
  double cse_p1_t28_g88564;
  double cse_p1_t29_g88565;
  double cse_p1_t2_g88538;
  double cse_p1_t30_g88566;
  double cse_p1_t31_g88567;
  double cse_p1_t32_g88568;
  double cse_p1_t33_g88569;
  double cse_p1_t34_g88570;
  double cse_p1_t35_g88571;
  double cse_p1_t36_g88572;
  double cse_p1_t37_g88573;
  double cse_p1_t38_g88574;
  double cse_p1_t39_g88575;
  double cse_p1_t3_g88539;
  double cse_p1_t40_g88576;
  double cse_p1_t41_g88577;
  double cse_p1_t42_g88578;
  double cse_p1_t43_g88579;
  double cse_p1_t44_g88580;
  double cse_p1_t45_g88581;
  double cse_p1_t46_g88582;
  double cse_p1_t47_g88583;
  double cse_p1_t4_g88540;
  double cse_p1_t5_g88541;
  double cse_p1_t6_g88542;
  double cse_p1_t7_g88543;
  double cse_p1_t8_g88544;
  double cse_p1_t9_g88545;
  double cse_p2_t1_g88594;
  double cse_p2_t1_g88595;
  double cse_p2_t1_g88596;
  double cse_p2_t1_g88597;
  double cse_p2_t1_g88598;
  double cse_p52_t1_g88605;
  double cse_p52_t1_g88606;
  double deltaphi;
  double dot_n1n2;
  double dx12;
  double dx23;
  double dx34;
  double dy12;
  double dy23;
  double dy34;
  double dz12;
  double dz23;
  double dz34;
  double energy;
  double g_x1;
  double g_x2;
  double g_x3;
  double g_x4;
  double g_y1;
  double g_y2;
  double g_y3;
  double g_y4;
  double g_z1;
  double g_z2;
  double g_z3;
  double g_z4;
  double inv_n1n2;
  double n1;
  double n1x;
  double n1y;
  double n1z;
  double n1_2;
  double n2;
  double n2x;
  double n2y;
  double n2z;
  double n2_2;
  double phi;
  double r12;
  double r12_2;
  double r23;
  double r23_2;
  double r34;
  double r34_2;
  DOUBLE x1 = position[i3x1 + 0];
  DOUBLE y1 = position[i3x1 + 1];
  DOUBLE z1 = position[i3x1 + 2];
  DOUBLE x2 = position[i3x2 + 0];
  DOUBLE y2 = position[i3x2 + 1];
  DOUBLE z2 = position[i3x2 + 2];
  DOUBLE x3 = position[i3x3 + 0];
  DOUBLE y3 = position[i3x3 + 1];
  DOUBLE z3 = position[i3x3 + 2];
  DOUBLE x4 = position[i3x4 + 0];
  DOUBLE y4 = position[i3x4 + 1];
  DOUBLE z4 = position[i3x4 + 2];
  {
    /* !BASE */
    dx12 = (x2 + (-(x1)));
    cse_p1_t34_g88570 = (-(dx12));
    dy12 = (y2 + (-(y1)));
    cse_p1_t37_g88573 = (-(dy12));
    dz12 = (z2 + (-(z1)));
    cse_p1_t40_g88576 = (-(dz12));
    dx23 = (x3 + (-(x2)));
    cse_p1_t20_g88556 = (cse_p1_t34_g88570 + (-(dx23)));
    cse_p1_t27_g88563 = (dx12 + dx23);
    cse_p1_t35_g88571 = (-(dx23));
    dy23 = (y3 + (-(y2)));
    cse_p1_t22_g88558 = (cse_p1_t37_g88573 + (-(dy23)));
    cse_p1_t29_g88565 = (dy12 + dy23);
    cse_p1_t38_g88574 = (-(dy23));
    dz23 = (z3 + (-(z2)));
    cse_p1_t24_g88560 = (cse_p1_t40_g88576 + (-(dz23)));
    cse_p1_t31_g88567 = (dz12 + dz23);
    cse_p1_t41_g88577 = (-(dz23));
    dx34 = (x4 + (-(x3)));
    cse_p1_t21_g88557 = (cse_p1_t35_g88571 + (-(dx34)));
    cse_p1_t28_g88564 = (dx23 + dx34);
    cse_p1_t36_g88572 = (-(dx34));
    dy34 = (y4 + (-(y3)));
    cse_p1_t23_g88559 = (cse_p1_t38_g88574 + (-(dy34)));
    cse_p1_t30_g88566 = (dy23 + dy34);
    cse_p1_t39_g88575 = (-(dy34));
    dz34 = (z4 + (-(z3)));
    cse_p1_t25_g88561 = (cse_p1_t41_g88577 + (-(dz34)));
    cse_p1_t32_g88568 = (dz23 + dz34);
    cse_p1_t42_g88578 = (-(dz34));
    r12_2 = ((dx12 * dx12) + (dy12 * dy12) + (dz12 * dz12));
    r23_2 = ((dx23 * dx23) + (dy23 * dy23) + (dz23 * dz23));
    r34_2 = ((dx34 * dx34) + (dy34 * dy34) + (dz34 * dz34));
    r12 = sqrt(r12_2);
    r23 = sqrt(r23_2);
    r34 = sqrt(r34_2);
    n1x = ((dy12 * dz23) + (-((dy23 * dz12))));
    cse_p1_t5_g88541 = (dy12 * n1x);
    cse_p1_t6_g88542 = (dy23 * n1x);
    cse_p1_t14_g88550 = (cse_p1_t31_g88567 * n1x);
    n1y = ((dx23 * dz12) + (-((dx12 * dz23))));
    cse_p1_t9_g88545 = (dz12 * n1y);
    cse_p1_t10_g88546 = (dz23 * n1y);
    cse_p1_t15_g88551 = (cse_p1_t27_g88563 * n1y);
    n1z = ((dx12 * dy23) + (-((dx23 * dy12))));
    cse_p1_t1_g88537 = (dx12 * n1z);
    cse_p1_t2_g88538 = (dx23 * n1z);
    cse_p1_t16_g88552 = (cse_p1_t29_g88565 * n1z);
    n2x = ((dy23 * dz34) + (-((dy34 * dz23))));
    cse_p1_t7_g88543 = (dy23 * n2x);
    cse_p1_t8_g88544 = (dy34 * n2x);
    cse_p1_t17_g88553 = (cse_p1_t32_g88568 * n2x);
    n2y = ((dx34 * dz23) + (-((dx23 * dz34))));
    cse_p1_t11_g88547 = (dz23 * n2y);
    cse_p1_t12_g88548 = (dz34 * n2y);
    cse_p1_t18_g88554 = (cse_p1_t28_g88564 * n2y);
    n2z = ((dx23 * dy34) + (-((dx34 * dy23))));
    cse_p1_t3_g88539 = (dx23 * n2z);
    cse_p1_t4_g88540 = (dx34 * n2z);
    cse_p1_t19_g88555 = (cse_p1_t30_g88566 * n2z);
    n1_2 = ((n1x * n1x) + (n1y * n1y) + (n1z * n1z));
    cse_p1_t46_g88582 = (1.0 / sqrt(n1_2));
    n2_2 = ((n2x * n2x) + (n2y * n2y) + (n2z * n2z));
    cse_p1_t47_g88583 = (1.0 / sqrt(n2_2));
    n1 = sqrt(n1_2);
    n2 = sqrt(n2_2);
    cse_p1_t13_g88549 = (n1 * n2);
    cse_p1_t43_g88579 = pow(cse_p1_t13_g88549, -2);
    dot_n1n2 = ((n1x * n2x) + (n1y * n2y) + (n1z * n2z));
    inv_n1n2 = (1.0 / (cse_p1_t13_g88549));
    cosphi = (dot_n1n2 * inv_n1n2);
    cse_p1_t26_g88562 = (1.0000000000000000     + (-(((cosphi) * (cosphi)))));
    cse_p1_t33_g88569 = (-(((cosphi) * (cosphi))));
    cse_p1_t44_g88580 = (1.0 / sqrt(cse_p1_t26_g88562));
    cse_p1_t45_g88581 = ((cosphi) * (cosphi));
    phi = acos(cosphi);
    deltaphi = (phi + (-(phi0)));
    cse_p2_t1_g88598 = (deltaphi * kdh);
    energy = (cse_p2_t1_g88598 * deltaphi);
    *energy_accumulate += energy;
    cse_p1_t1_g88584 = (2.0000000000000000     * cse_p2_t1_g88598);
    cse_p1_t1_g88585 = (cse_p1_t46_g88582 * n2);
    cse_p52_t1_g88606 = (cse_p1_t43_g88579 * dot_n1n2);
    cse_p1_t1_g88587 = (-0.50000000000000000     * cse_p52_t1_g88606);
    cse_p1_t1_g88592 = (2.0000000000000000     * n1z);
    cse_p2_t1_g88596 = (cse_p1_t1_g88585 * cse_p1_t1_g88587);
    cse_p52_t1_g88605 = (cse_p1_t1_g88584 * cse_p1_t44_g88580);
    g_x1 = (-((cse_p52_t1_g88605 * ((cse_p2_t1_g88596 * (cse_p1_t10_g88546 + cse_p1_t10_g88546 + (cse_p1_t1_g88592 * cse_p1_t38_g88574))) + (inv_n1n2 * (cse_p1_t11_g88547 + (cse_p1_t38_g88574 * n2z)))))));
    KernelGradientAcc(i3x1, 0, g_x1);
    cse_p1_t1_g88590 = (2.0000000000000000     * n1x);
    g_y1 = (-((cse_p52_t1_g88605 * ((cse_p2_t1_g88596 * (cse_p1_t2_g88538 + cse_p1_t2_g88538 + (cse_p1_t1_g88590 * cse_p1_t41_g88577))) + (inv_n1n2 * (cse_p1_t3_g88539 + (cse_p1_t41_g88577 * n2x)))))));
    KernelGradientAcc(i3x1, 1, g_y1);
    cse_p1_t1_g88591 = (2.0000000000000000     * n1y);
    g_z1 = (-((cse_p52_t1_g88605 * ((cse_p2_t1_g88596 * (cse_p1_t6_g88542 + cse_p1_t6_g88542 + (cse_p1_t1_g88591 * cse_p1_t35_g88571))) + (inv_n1n2 * (cse_p1_t7_g88543 + (cse_p1_t35_g88571 * n2y)))))));
    KernelGradientAcc(i3x1, 2, g_z1);
    cse_p1_t1_g88586 = (cse_p1_t47_g88583 * n1);
    cse_p1_t1_g88588 = (0.50000000000000000     * cse_p1_t1_g88585);
    cse_p1_t1_g88589 = (0.50000000000000000     * cse_p1_t1_g88586);
    cse_p2_t1_g88595 = (2.0000000000000000     * n2z);
    g_x2 = (-((cse_p52_t1_g88605 * ((inv_n1n2 * ((cse_p1_t24_g88560 * n2y) + (cse_p1_t29_g88565 * n2z) + (cse_p1_t39_g88575 * n1z) + (dz34 * n1y))) + (-((cse_p52_t1_g88606 * ((cse_p1_t1_g88588 * (cse_p1_t16_g88552 + cse_p1_t16_g88552 + (cse_p1_t1_g88591 * cse_p1_t24_g88560))) + (cse_p1_t1_g88589 * (cse_p1_t12_g88548 + cse_p1_t12_g88548 + (cse_p1_t39_g88575 * cse_p2_t1_g88595)))))))))));
    KernelGradientAcc(i3x2, 0, g_x2);
    cse_p1_t1_g88593 = (2.0000000000000000     * n2x);
    g_y2 = (-((cse_p52_t1_g88605 * ((inv_n1n2 * ((cse_p1_t20_g88556 * n2z) + (cse_p1_t31_g88567 * n2x) + (cse_p1_t42_g88578 * n1x) + (dx34 * n1z))) + (-((cse_p52_t1_g88606 * ((cse_p1_t1_g88588 * (cse_p1_t14_g88550 + cse_p1_t14_g88550 + (cse_p1_t1_g88592 * cse_p1_t20_g88556))) + (cse_p1_t1_g88589 * (cse_p1_t4_g88540 + cse_p1_t4_g88540 + (cse_p1_t1_g88593 * cse_p1_t42_g88578)))))))))));
    KernelGradientAcc(i3x2, 1, g_y2);
    cse_p2_t1_g88594 = (2.0000000000000000     * n2y);
    g_z2 = (-((cse_p52_t1_g88605 * ((inv_n1n2 * ((cse_p1_t22_g88558 * n2x) + (cse_p1_t27_g88563 * n2y) + (cse_p1_t36_g88572 * n1y) + (dy34 * n1x))) + (-((cse_p52_t1_g88606 * ((cse_p1_t1_g88588 * (cse_p1_t15_g88551 + cse_p1_t15_g88551 + (cse_p1_t1_g88590 * cse_p1_t22_g88558))) + (cse_p1_t1_g88589 * (cse_p1_t8_g88544 + cse_p1_t8_g88544 + (cse_p1_t36_g88572 * cse_p2_t1_g88594)))))))))));
    KernelGradientAcc(i3x2, 2, g_z2);
    g_x3 = (-((cse_p52_t1_g88605 * ((inv_n1n2 * ((cse_p1_t25_g88561 * n1y) + (cse_p1_t30_g88566 * n1z) + (cse_p1_t37_g88573 * n2z) + (dz12 * n2y))) + (-((cse_p52_t1_g88606 * ((cse_p1_t1_g88588 * (cse_p1_t9_g88545 + cse_p1_t9_g88545 + (cse_p1_t1_g88592 * cse_p1_t37_g88573))) + (cse_p1_t1_g88589 * (cse_p1_t19_g88555 + cse_p1_t19_g88555 + (cse_p1_t25_g88561 * cse_p2_t1_g88594)))))))))));
    KernelGradientAcc(i3x3, 0, g_x3);
    g_y3 = (-((cse_p52_t1_g88605 * ((inv_n1n2 * ((cse_p1_t21_g88557 * n1z) + (cse_p1_t32_g88568 * n1x) + (cse_p1_t40_g88576 * n2x) + (dx12 * n2z))) + (-((cse_p52_t1_g88606 * ((cse_p1_t1_g88588 * (cse_p1_t1_g88537 + cse_p1_t1_g88537 + (cse_p1_t1_g88590 * cse_p1_t40_g88576))) + (cse_p1_t1_g88589 * (cse_p1_t17_g88553 + cse_p1_t17_g88553 + (cse_p1_t21_g88557 * cse_p2_t1_g88595)))))))))));
    KernelGradientAcc(i3x3, 1, g_y3);
    g_z3 = (-((cse_p52_t1_g88605 * ((inv_n1n2 * ((cse_p1_t23_g88559 * n1x) + (cse_p1_t28_g88564 * n1y) + (cse_p1_t34_g88570 * n2y) + (dy12 * n2x))) + (-((cse_p52_t1_g88606 * ((cse_p1_t1_g88588 * (cse_p1_t5_g88541 + cse_p1_t5_g88541 + (cse_p1_t1_g88591 * cse_p1_t34_g88570))) + (cse_p1_t1_g88589 * (cse_p1_t18_g88554 + cse_p1_t18_g88554 + (cse_p1_t1_g88593 * cse_p1_t23_g88559)))))))))));
    KernelGradientAcc(i3x3, 2, g_z3);
    cse_p2_t1_g88597 = (cse_p1_t1_g88586 * cse_p1_t1_g88587);
    g_x4 = (-((cse_p52_t1_g88605 * ((cse_p2_t1_g88597 * (cse_p1_t11_g88547 + cse_p1_t11_g88547 + (cse_p1_t38_g88574 * cse_p2_t1_g88595))) + (inv_n1n2 * (cse_p1_t10_g88546 + (cse_p1_t38_g88574 * n1z)))))));
    KernelGradientAcc(i3x4, 0, g_x4);
    g_y4 = (-((cse_p52_t1_g88605 * ((cse_p2_t1_g88597 * (cse_p1_t3_g88539 + cse_p1_t3_g88539 + (cse_p1_t1_g88593 * cse_p1_t41_g88577))) + (inv_n1n2 * (cse_p1_t2_g88538 + (cse_p1_t41_g88577 * n1x)))))));
    KernelGradientAcc(i3x4, 1, g_y4);
    g_z4 = (-((cse_p52_t1_g88605 * ((cse_p2_t1_g88597 * (cse_p1_t7_g88543 + cse_p1_t7_g88543 + (cse_p1_t35_g88571 * cse_p2_t1_g88594))) + (inv_n1n2 * (cse_p1_t6_g88542 + (cse_p1_t35_g88571 * n1y)))))));
    KernelGradientAcc(i3x4, 2, g_z4);
  }
}
void gradient_fd(double kdh, double phi0, size_t i3x1, size_t i3x2, size_t i3x3, size_t i3x4, double* position, double* energy_accumulate, double* force, HESSIAN hessian, double* dvec, double* hdvec)
{
  constexpr size_t PositionSize = 12;
  const double h = 1.0e-5;
  const double inv2h = 1.0/(2.0*h);
  double e0 = 0.0;
  energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e0, 0, 0, 0, 0);
  if (energy_accumulate) { *energy_accumulate += e0; }
  {
    double saved = position[i3x1 + 0];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x1 + 0] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x1 + 0] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x1 + 0] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x1, 0, d);
  }
  {
    double saved = position[i3x1 + 1];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x1 + 1] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x1 + 1] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x1 + 1] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x1, 1, d);
  }
  {
    double saved = position[i3x1 + 2];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x1 + 2] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x1 + 2] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x1 + 2] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x1, 2, d);
  }
  {
    double saved = position[i3x2 + 0];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x2 + 0] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x2 + 0] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x2 + 0] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x2, 0, d);
  }
  {
    double saved = position[i3x2 + 1];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x2 + 1] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x2 + 1] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x2 + 1] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x2, 1, d);
  }
  {
    double saved = position[i3x2 + 2];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x2 + 2] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x2 + 2] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x2 + 2] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x2, 2, d);
  }
  {
    double saved = position[i3x3 + 0];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x3 + 0] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x3 + 0] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x3 + 0] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x3, 0, d);
  }
  {
    double saved = position[i3x3 + 1];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x3 + 1] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x3 + 1] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x3 + 1] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x3, 1, d);
  }
  {
    double saved = position[i3x3 + 2];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x3 + 2] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x3 + 2] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x3 + 2] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x3, 2, d);
  }
  {
    double saved = position[i3x4 + 0];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x4 + 0] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x4 + 0] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x4 + 0] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x4, 0, d);
  }
  {
    double saved = position[i3x4 + 1];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x4 + 1] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x4 + 1] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x4 + 1] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x4, 1, d);
  }
  {
    double saved = position[i3x4 + 2];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x4 + 2] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x4 + 2] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x4 + 2] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x4, 2, d);
  }
}

void hessian(double kdh, double phi0, size_t i3x1, size_t i3x2, size_t i3x3, size_t i3x4, double* position, double* energy_accumulate, double* force, HESSIAN hessian, double* dvec, double* hdvec) {
  /* !BASE */
  double cosphi;
  double cse_p1030_t1_g89075;
  double cse_p1_t10_g88730;
  double cse_p1_t11_g88731;
  double cse_p1_t12_g88732;
  double cse_p1_t1_g88721;
  double cse_p1_t1_g88768;
  double cse_p1_t1_g88771;
  double cse_p1_t26_g88746;
  double cse_p1_t27_g88747;
  double cse_p1_t28_g88748;
  double cse_p1_t29_g88749;
  double cse_p1_t2_g88722;
  double cse_p1_t30_g88750;
  double cse_p1_t31_g88751;
  double cse_p1_t32_g88752;
  double cse_p1_t33_g88753;
  double cse_p1_t34_g88754;
  double cse_p1_t35_g88755;
  double cse_p1_t36_g88756;
  double cse_p1_t37_g88757;
  double cse_p1_t38_g88758;
  double cse_p1_t39_g88759;
  double cse_p1_t3_g88723;
  double cse_p1_t40_g88760;
  double cse_p1_t41_g88761;
  double cse_p1_t42_g88762;
  double cse_p1_t44_g88764;
  double cse_p1_t45_g88765;
  double cse_p1_t4_g88724;
  double cse_p1_t5_g88725;
  double cse_p1_t6_g88726;
  double cse_p1_t7_g88727;
  double cse_p1_t8_g88728;
  double cse_p1_t9_g88729;
  double cse_p2_t1_g88780;
  double cse_p2_t1_g88781;
  double cse_p2_t1_g88782;
  double cse_p511_t100_g88944;
  double cse_p511_t101_g88945;
  double cse_p511_t102_g88946;
  double cse_p511_t103_g88947;
  double cse_p511_t104_g88948;
  double cse_p511_t105_g88949;
  double cse_p511_t106_g88950;
  double cse_p511_t107_g88951;
  double cse_p511_t108_g88952;
  double cse_p511_t109_g88953;
  double cse_p511_t10_g88854;
  double cse_p511_t110_g88954;
  double cse_p511_t111_g88955;
  double cse_p511_t112_g88956;
  double cse_p511_t113_g88957;
  double cse_p511_t114_g88958;
  double cse_p511_t115_g88959;
  double cse_p511_t116_g88960;
  double cse_p511_t117_g88961;
  double cse_p511_t118_g88962;
  double cse_p511_t119_g88963;
  double cse_p511_t11_g88855;
  double cse_p511_t120_g88964;
  double cse_p511_t121_g88965;
  double cse_p511_t122_g88966;
  double cse_p511_t123_g88967;
  double cse_p511_t124_g88968;
  double cse_p511_t125_g88969;
  double cse_p511_t126_g88970;
  double cse_p511_t127_g88971;
  double cse_p511_t128_g88972;
  double cse_p511_t129_g88973;
  double cse_p511_t12_g88856;
  double cse_p511_t130_g88974;
  double cse_p511_t131_g88975;
  double cse_p511_t132_g88976;
  double cse_p511_t133_g88977;
  double cse_p511_t134_g88978;
  double cse_p511_t135_g88979;
  double cse_p511_t136_g88980;
  double cse_p511_t137_g88981;
  double cse_p511_t138_g88982;
  double cse_p511_t139_g88983;
  double cse_p511_t13_g88857;
  double cse_p511_t140_g88984;
  double cse_p511_t141_g88985;
  double cse_p511_t142_g88986;
  double cse_p511_t143_g88987;
  double cse_p511_t144_g88988;
  double cse_p511_t145_g88989;
  double cse_p511_t146_g88990;
  double cse_p511_t147_g88991;
  double cse_p511_t148_g88992;
  double cse_p511_t149_g88993;
  double cse_p511_t14_g88858;
  double cse_p511_t150_g88994;
  double cse_p511_t151_g88995;
  double cse_p511_t152_g88996;
  double cse_p511_t153_g88997;
  double cse_p511_t154_g88998;
  double cse_p511_t155_g88999;
  double cse_p511_t156_g89000;
  double cse_p511_t157_g89001;
  double cse_p511_t158_g89002;
  double cse_p511_t159_g89003;
  double cse_p511_t15_g88859;
  double cse_p511_t160_g89004;
  double cse_p511_t161_g89005;
  double cse_p511_t162_g89006;
  double cse_p511_t163_g89007;
  double cse_p511_t164_g89008;
  double cse_p511_t165_g89009;
  double cse_p511_t166_g89010;
  double cse_p511_t167_g89011;
  double cse_p511_t168_g89012;
  double cse_p511_t169_g89013;
  double cse_p511_t16_g88860;
  double cse_p511_t170_g89014;
  double cse_p511_t171_g89015;
  double cse_p511_t172_g89016;
  double cse_p511_t173_g89017;
  double cse_p511_t174_g89018;
  double cse_p511_t175_g89019;
  double cse_p511_t176_g89020;
  double cse_p511_t177_g89021;
  double cse_p511_t178_g89022;
  double cse_p511_t179_g89023;
  double cse_p511_t17_g88861;
  double cse_p511_t180_g89024;
  double cse_p511_t18_g88862;
  double cse_p511_t19_g88863;
  double cse_p511_t1_g88845;
  double cse_p511_t1_g89027;
  double cse_p511_t1_g89028;
  double cse_p511_t20_g88864;
  double cse_p511_t21_g88865;
  double cse_p511_t22_g88866;
  double cse_p511_t23_g88867;
  double cse_p511_t24_g88868;
  double cse_p511_t2_g88846;
  double cse_p511_t37_g88881;
  double cse_p511_t38_g88882;
  double cse_p511_t39_g88883;
  double cse_p511_t3_g88847;
  double cse_p511_t40_g88884;
  double cse_p511_t41_g88885;
  double cse_p511_t42_g88886;
  double cse_p511_t43_g88887;
  double cse_p511_t44_g88888;
  double cse_p511_t45_g88889;
  double cse_p511_t46_g88890;
  double cse_p511_t47_g88891;
  double cse_p511_t48_g88892;
  double cse_p511_t49_g88893;
  double cse_p511_t4_g88848;
  double cse_p511_t50_g88894;
  double cse_p511_t51_g88895;
  double cse_p511_t52_g88896;
  double cse_p511_t53_g88897;
  double cse_p511_t54_g88898;
  double cse_p511_t55_g88899;
  double cse_p511_t56_g88900;
  double cse_p511_t57_g88901;
  double cse_p511_t58_g88902;
  double cse_p511_t59_g88903;
  double cse_p511_t5_g88849;
  double cse_p511_t60_g88904;
  double cse_p511_t61_g88905;
  double cse_p511_t62_g88906;
  double cse_p511_t63_g88907;
  double cse_p511_t64_g88908;
  double cse_p511_t65_g88909;
  double cse_p511_t66_g88910;
  double cse_p511_t67_g88911;
  double cse_p511_t68_g88912;
  double cse_p511_t69_g88913;
  double cse_p511_t6_g88850;
  double cse_p511_t70_g88914;
  double cse_p511_t71_g88915;
  double cse_p511_t72_g88916;
  double cse_p511_t73_g88917;
  double cse_p511_t74_g88918;
  double cse_p511_t75_g88919;
  double cse_p511_t76_g88920;
  double cse_p511_t77_g88921;
  double cse_p511_t78_g88922;
  double cse_p511_t79_g88923;
  double cse_p511_t7_g88851;
  double cse_p511_t80_g88924;
  double cse_p511_t81_g88925;
  double cse_p511_t82_g88926;
  double cse_p511_t83_g88927;
  double cse_p511_t84_g88928;
  double cse_p511_t85_g88929;
  double cse_p511_t86_g88930;
  double cse_p511_t87_g88931;
  double cse_p511_t88_g88932;
  double cse_p511_t89_g88933;
  double cse_p511_t8_g88852;
  double cse_p511_t90_g88934;
  double cse_p511_t91_g88935;
  double cse_p511_t92_g88936;
  double cse_p511_t93_g88937;
  double cse_p511_t94_g88938;
  double cse_p511_t95_g88939;
  double cse_p511_t96_g88940;
  double cse_p511_t97_g88941;
  double cse_p511_t98_g88942;
  double cse_p511_t99_g88943;
  double cse_p511_t9_g88853;
  double cse_p512_t1_g89029;
  double cse_p515_t1_g89030;
  double cse_p515_t1_g89031;
  double cse_p515_t1_g89032;
  double cse_p515_t1_g89033;
  double cse_p515_t1_g89034;
  double cse_p515_t1_g89035;
  double cse_p515_t1_g89036;
  double cse_p515_t1_g89037;
  double cse_p515_t1_g89038;
  double cse_p515_t1_g89039;
  double cse_p516_t1_g89040;
  double cse_p516_t1_g89041;
  double cse_p516_t1_g89042;
  double cse_p516_t1_g89043;
  double cse_p516_t1_g89044;
  double cse_p516_t1_g89045;
  double cse_p516_t1_g89046;
  double cse_p52_t1_g88789;
  double cse_p561_t1_sqrt89047;
  double cse_p561_t2_invsqrt89048;
  double cse_p561_t3_sqrt89049;
  double cse_p561_t4_invsqrt89050;
  double cse_p561_t5_invr89051;
  double cse_p561_t9_invsqrt89055;
  double cse_p562_t1_g89056;
  double cse_p563_t1_g89057;
  double cse_p563_t1_g89058;
  double cse_p563_t1_g89059;
  double cse_p614_t1_g89060;
  double cse_p666_t1_g89061;
  double cse_p667_t1_g89062;
  double cse_p667_t1_g89063;
  double cse_p718_t1_g89064;
  double cse_p770_t1_g89065;
  double cse_p822_t1_g89066;
  double cse_p874_t1_g89067;
  double cse_p875_t1_g89068;
  double cse_p875_t1_g89069;
  double cse_p875_t1_g89070;
  double cse_p875_t1_g89071;
  double cse_p875_t1_g89072;
  double cse_p926_t1_g89073;
  double cse_p978_t1_g89074;
  double deltaphi;
  double dot_n1n2;
  double dx12;
  double dx23;
  double dx34;
  double dy12;
  double dy23;
  double dy34;
  double dz12;
  double dz23;
  double dz34;
  double energy;
  double g_x1;
  double g_x2;
  double g_x3;
  double g_x4;
  double g_y1;
  double g_y2;
  double g_y3;
  double g_y4;
  double g_z1;
  double g_z2;
  double g_z3;
  double g_z4;
  double h_x1_x1;
  double h_x1_x2;
  double h_x1_x3;
  double h_x1_x4;
  double h_x1_y1;
  double h_x1_y2;
  double h_x1_y3;
  double h_x1_y4;
  double h_x1_z1;
  double h_x1_z2;
  double h_x1_z3;
  double h_x1_z4;
  double h_x2_x2;
  double h_x2_x3;
  double h_x2_x4;
  double h_x2_y2;
  double h_x2_y3;
  double h_x2_y4;
  double h_x2_z2;
  double h_x2_z3;
  double h_x2_z4;
  double h_x3_x3;
  double h_x3_x4;
  double h_x3_y3;
  double h_x3_y4;
  double h_x3_z3;
  double h_x3_z4;
  double h_x4_x4;
  double h_x4_y4;
  double h_x4_z4;
  double h_y1_x2;
  double h_y1_x3;
  double h_y1_x4;
  double h_y1_y1;
  double h_y1_y2;
  double h_y1_y3;
  double h_y1_y4;
  double h_y1_z1;
  double h_y1_z2;
  double h_y1_z3;
  double h_y1_z4;
  double h_y2_x3;
  double h_y2_x4;
  double h_y2_y2;
  double h_y2_y3;
  double h_y2_y4;
  double h_y2_z2;
  double h_y2_z3;
  double h_y2_z4;
  double h_y3_x4;
  double h_y3_y3;
  double h_y3_y4;
  double h_y3_z3;
  double h_y3_z4;
  double h_y4_y4;
  double h_y4_z4;
  double h_z1_x2;
  double h_z1_x3;
  double h_z1_x4;
  double h_z1_y2;
  double h_z1_y3;
  double h_z1_y4;
  double h_z1_z1;
  double h_z1_z2;
  double h_z1_z3;
  double h_z1_z4;
  double h_z2_x3;
  double h_z2_x4;
  double h_z2_y3;
  double h_z2_y4;
  double h_z2_z2;
  double h_z2_z3;
  double h_z2_z4;
  double h_z3_x4;
  double h_z3_y4;
  double h_z3_z3;
  double h_z3_z4;
  double h_z4_z4;
  double n1x;
  double n1y;
  double n1z;
  double n1_2;
  double n2x;
  double n2y;
  double n2z;
  double n2_2;
  double phi;
  double r12;
  double r12_2;
  double r23;
  double r23_2;
  double r34;
  double r34_2;
  DOUBLE x1 = position[i3x1 + 0];
  DOUBLE y1 = position[i3x1 + 1];
  DOUBLE z1 = position[i3x1 + 2];
  DOUBLE x2 = position[i3x2 + 0];
  DOUBLE y2 = position[i3x2 + 1];
  DOUBLE z2 = position[i3x2 + 2];
  DOUBLE x3 = position[i3x3 + 0];
  DOUBLE y3 = position[i3x3 + 1];
  DOUBLE z3 = position[i3x3 + 2];
  DOUBLE x4 = position[i3x4 + 0];
  DOUBLE y4 = position[i3x4 + 1];
  DOUBLE z4 = position[i3x4 + 2];
  {
    /* !BASE */
    dx12 = (x2 + (-(x1)));
    cse_p1_t34_g88754 = (-(dx12));
    dy12 = (y2 + (-(y1)));
    cse_p1_t37_g88757 = (-(dy12));
    dz12 = (z2 + (-(z1)));
    cse_p1_t40_g88760 = (-(dz12));
    dx23 = (x3 + (-(x2)));
    cse_p511_t157_g89001 = (cse_p1_t34_g88754 + (-(dx23)));
    cse_p1_t27_g88747 = (dx12 + dx23);
    cse_p1_t35_g88755 = (-(dx23));
    dy23 = (y3 + (-(y2)));
    cse_p511_t159_g89003 = (cse_p1_t37_g88757 + (-(dy23)));
    cse_p1_t29_g88749 = (dy12 + dy23);
    cse_p1_t38_g88758 = (-(dy23));
    dz23 = (z3 + (-(z2)));
    cse_p511_t161_g89005 = (cse_p1_t40_g88760 + (-(dz23)));
    cse_p1_t31_g88751 = (dz12 + dz23);
    cse_p1_t41_g88761 = (-(dz23));
    dx34 = (x4 + (-(x3)));
    cse_p511_t158_g89002 = (cse_p1_t35_g88755 + (-(dx34)));
    cse_p1_t28_g88748 = (dx23 + dx34);
    cse_p1_t36_g88756 = (-(dx34));
    dy34 = (y4 + (-(y3)));
    cse_p511_t160_g89004 = (cse_p1_t38_g88758 + (-(dy34)));
    cse_p1_t30_g88750 = (dy23 + dy34);
    cse_p1_t39_g88759 = (-(dy34));
    dz34 = (z4 + (-(z3)));
    cse_p511_t162_g89006 = (cse_p1_t41_g88761 + (-(dz34)));
    cse_p1_t32_g88752 = (dz23 + dz34);
    cse_p1_t42_g88762 = (-(dz34));
    r12_2 = ((dx12 * dx12) + (dy12 * dy12) + (dz12 * dz12));
    r23_2 = ((dx23 * dx23) + (dy23 * dy23) + (dz23 * dz23));
    r34_2 = ((dx34 * dx34) + (dy34 * dy34) + (dz34 * dz34));
    r12 = sqrt(r12_2);
    r23 = sqrt(r23_2);
    r34 = sqrt(r34_2);
    n1x = ((dy12 * dz23) + (-((dy23 * dz12))));
    cse_p718_t1_g89064 = (2.0000000000000000     * n1x);
    cse_p511_t37_g88881 = (cse_p511_t159_g89003 * cse_p718_t1_g89064);
    cse_p511_t38_g88882 = (cse_p1_t40_g88760 * cse_p718_t1_g89064);
    cse_p511_t39_g88883 = (cse_p1_t41_g88761 * cse_p718_t1_g89064);
    cse_p511_t64_g88908 = (dy34 * n1x);
    cse_p511_t79_g88923 = (cse_p511_t160_g89004 * n1x);
    cse_p511_t80_g88924 = (cse_p1_t31_g88751 * n1x);
    cse_p511_t81_g88925 = (cse_p1_t32_g88752 * n1x);
    cse_p511_t82_g88926 = (cse_p1_t41_g88761 * n1x);
    cse_p511_t83_g88927 = (cse_p1_t42_g88762 * n1x);
    cse_p1_t5_g88725 = (dy12 * n1x);
    cse_p1_t6_g88726 = (dy23 * n1x);
    n1y = ((dx23 * dz12) + (-((dx12 * dz23))));
    cse_p770_t1_g89065 = (2.0000000000000000     * n1y);
    cse_p511_t40_g88884 = (cse_p511_t161_g89005 * cse_p770_t1_g89065);
    cse_p511_t41_g88885 = (cse_p1_t34_g88754 * cse_p770_t1_g89065);
    cse_p511_t42_g88886 = (cse_p1_t35_g88755 * cse_p770_t1_g89065);
    cse_p511_t66_g88910 = (dz34 * n1y);
    cse_p511_t84_g88928 = (cse_p511_t162_g89006 * n1y);
    cse_p511_t85_g88929 = (cse_p1_t27_g88747 * n1y);
    cse_p511_t86_g88930 = (cse_p1_t28_g88748 * n1y);
    cse_p511_t87_g88931 = (cse_p1_t35_g88755 * n1y);
    cse_p511_t88_g88932 = (cse_p1_t36_g88756 * n1y);
    cse_p511_t127_g88971 = (cse_p511_t37_g88881 + cse_p511_t85_g88929 + cse_p511_t85_g88929);
    cse_p511_t131_g88975 = (cse_p1_t5_g88725 + cse_p1_t5_g88725 + cse_p511_t41_g88885);
    cse_p511_t132_g88976 = (cse_p1_t6_g88726 + cse_p1_t6_g88726 + cse_p511_t42_g88886);
    cse_p511_t150_g88994 = (cse_p1_t6_g88726 + cse_p511_t87_g88931);
    cse_p1_t9_g88729 = (dz12 * n1y);
    cse_p1_t10_g88730 = (dz23 * n1y);
    n1z = ((dx12 * dy23) + (-((dx23 * dy12))));
    cse_p614_t1_g89060 = (2.0000000000000000     * n1z);
    cse_p511_t43_g88887 = (cse_p511_t157_g89001 * cse_p614_t1_g89060);
    cse_p511_t44_g88888 = (cse_p1_t37_g88757 * cse_p614_t1_g89060);
    cse_p511_t45_g88889 = (cse_p1_t38_g88758 * cse_p614_t1_g89060);
    cse_p511_t62_g88906 = (dx34 * n1z);
    cse_p511_t89_g88933 = (cse_p511_t158_g89002 * n1z);
    cse_p511_t90_g88934 = (cse_p1_t29_g88749 * n1z);
    cse_p511_t91_g88935 = (cse_p1_t30_g88750 * n1z);
    cse_p511_t92_g88936 = (cse_p1_t38_g88758 * n1z);
    cse_p511_t93_g88937 = (cse_p1_t39_g88759 * n1z);
    cse_p511_t128_g88972 = (cse_p511_t38_g88882 + (cse_p614_t1_g89060 * dx12));
    cse_p511_t129_g88973 = (cse_p511_t39_g88883 + (cse_p614_t1_g89060 * dx23));
    cse_p511_t130_g88974 = (cse_p511_t40_g88884 + cse_p511_t90_g88934 + cse_p511_t90_g88934);
    cse_p511_t133_g88977 = (cse_p511_t43_g88887 + cse_p511_t80_g88924 + cse_p511_t80_g88924);
    cse_p511_t134_g88978 = (cse_p1_t9_g88729 + cse_p1_t9_g88729 + cse_p511_t44_g88888);
    cse_p511_t135_g88979 = (cse_p1_t10_g88730 + cse_p1_t10_g88730 + cse_p511_t45_g88889);
    cse_p511_t146_g88990 = (cse_p511_t82_g88926 + (dx23 * n1z));
    cse_p511_t154_g88998 = (cse_p1_t10_g88730 + cse_p511_t92_g88936);
    cse_p1_t1_g88721 = (dx12 * n1z);
    cse_p1_t2_g88722 = (dx23 * n1z);
    n2x = ((dy23 * dz34) + (-((dy34 * dz23))));
    cse_p822_t1_g89066 = (2.0000000000000000     * n2x);
    cse_p511_t46_g88890 = (cse_p511_t160_g89004 * cse_p822_t1_g89066);
    cse_p511_t47_g88891 = (cse_p1_t41_g88761 * cse_p822_t1_g89066);
    cse_p511_t48_g88892 = (cse_p1_t42_g88762 * cse_p822_t1_g89066);
    cse_p511_t63_g88907 = (dy12 * n2x);
    cse_p511_t94_g88938 = (cse_p511_t159_g89003 * n2x);
    cse_p511_t95_g88939 = (cse_p1_t31_g88751 * n2x);
    cse_p511_t96_g88940 = (cse_p1_t32_g88752 * n2x);
    cse_p511_t97_g88941 = (cse_p1_t40_g88760 * n2x);
    cse_p511_t98_g88942 = (cse_p1_t41_g88761 * n2x);
    cse_p1_t7_g88727 = (dy23 * n2x);
    cse_p1_t8_g88728 = (dy34 * n2x);
    n2y = ((dx34 * dz23) + (-((dx23 * dz34))));
    cse_p874_t1_g89067 = (2.0000000000000000     * n2y);
    cse_p511_t49_g88893 = (cse_p511_t162_g89006 * cse_p874_t1_g89067);
    cse_p511_t50_g88894 = (cse_p1_t35_g88755 * cse_p874_t1_g89067);
    cse_p511_t51_g88895 = (cse_p1_t36_g88756 * cse_p874_t1_g89067);
    cse_p511_t65_g88909 = (dz12 * n2y);
    cse_p511_t99_g88943 = (cse_p511_t161_g89005 * n2y);
    cse_p511_t100_g88944 = (cse_p1_t27_g88747 * n2y);
    cse_p511_t101_g88945 = (cse_p1_t28_g88748 * n2y);
    cse_p511_t102_g88946 = (cse_p1_t34_g88754 * n2y);
    cse_p511_t103_g88947 = (cse_p1_t35_g88755 * n2y);
    cse_p511_t136_g88980 = (cse_p511_t101_g88945 + cse_p511_t101_g88945 + cse_p511_t46_g88890);
    cse_p511_t140_g88984 = (cse_p1_t7_g88727 + cse_p1_t7_g88727 + cse_p511_t50_g88894);
    cse_p511_t141_g88985 = (cse_p1_t8_g88728 + cse_p1_t8_g88728 + cse_p511_t51_g88895);
    cse_p511_t149_g88993 = (cse_p511_t102_g88946 + cse_p511_t63_g88907 + cse_p511_t79_g88923 + cse_p511_t86_g88930);
    cse_p511_t151_g88995 = (cse_p1_t7_g88727 + cse_p511_t103_g88947);
    cse_p511_t152_g88996 = (cse_p511_t100_g88944 + cse_p511_t64_g88908 + cse_p511_t88_g88932 + cse_p511_t94_g88938);
    cse_p1_t11_g88731 = (dz23 * n2y);
    cse_p1_t12_g88732 = (dz34 * n2y);
    n2z = ((dx23 * dy34) + (-((dx34 * dy23))));
    cse_p666_t1_g89061 = (2.0000000000000000     * n2z);
    cse_p511_t52_g88896 = (cse_p511_t158_g89002 * cse_p666_t1_g89061);
    cse_p511_t53_g88897 = (cse_p1_t38_g88758 * cse_p666_t1_g89061);
    cse_p511_t54_g88898 = (cse_p1_t39_g88759 * cse_p666_t1_g89061);
    cse_p511_t61_g88905 = (dx12 * n2z);
    cse_p511_t104_g88948 = (cse_p511_t157_g89001 * n2z);
    cse_p511_t105_g88949 = (cse_p1_t29_g88749 * n2z);
    cse_p511_t106_g88950 = (cse_p1_t30_g88750 * n2z);
    cse_p511_t107_g88951 = (cse_p1_t37_g88757 * n2z);
    cse_p511_t108_g88952 = (cse_p1_t38_g88758 * n2z);
    cse_p511_t137_g88981 = (cse_p511_t47_g88891 + (cse_p666_t1_g89061 * dx23));
    cse_p511_t138_g88982 = (cse_p511_t48_g88892 + (cse_p666_t1_g89061 * dx34));
    cse_p511_t139_g88983 = (cse_p511_t106_g88950 + cse_p511_t106_g88950 + cse_p511_t49_g88893);
    cse_p511_t142_g88986 = (cse_p511_t52_g88896 + cse_p511_t96_g88940 + cse_p511_t96_g88940);
    cse_p511_t143_g88987 = (cse_p1_t11_g88731 + cse_p1_t11_g88731 + cse_p511_t53_g88897);
    cse_p511_t144_g88988 = (cse_p1_t12_g88732 + cse_p1_t12_g88732 + cse_p511_t54_g88898);
    cse_p511_t145_g88989 = (cse_p511_t61_g88905 + cse_p511_t81_g88925 + cse_p511_t89_g88933 + cse_p511_t97_g88941);
    cse_p511_t147_g88991 = (cse_p511_t98_g88942 + (dx23 * n2z));
    cse_p511_t148_g88992 = (cse_p511_t104_g88948 + cse_p511_t62_g88906 + cse_p511_t83_g88927 + cse_p511_t95_g88939);
    cse_p511_t153_g88997 = (cse_p511_t107_g88951 + cse_p511_t65_g88909 + cse_p511_t84_g88928 + cse_p511_t91_g88935);
    cse_p511_t155_g88999 = (cse_p1_t11_g88731 + cse_p511_t108_g88952);
    cse_p511_t156_g89000 = (cse_p511_t105_g88949 + cse_p511_t66_g88910 + cse_p511_t93_g88937 + cse_p511_t99_g88943);
    cse_p1_t3_g88723 = (dx23 * n2z);
    cse_p1_t4_g88724 = (dx34 * n2z);
    n1_2 = ((n1x * n1x) + (n1y * n1y) + (n1z * n1z));
    cse_p561_t1_sqrt89047 = sqrt(n1_2);
    cse_p561_t2_invsqrt89048 = (1.0 / (cse_p561_t1_sqrt89047));
    n2_2 = ((n2x * n2x) + (n2y * n2y) + (n2z * n2z));
    cse_p561_t3_sqrt89049 = sqrt(n2_2);
    cse_p926_t1_g89073 = (cse_p561_t1_sqrt89047 * cse_p561_t3_sqrt89049);
    cse_p561_t4_invsqrt89050 = (1.0 / (cse_p561_t3_sqrt89049));
    cse_p511_t1_g89028 = (cse_p561_t1_sqrt89047 * cse_p561_t4_invsqrt89050);
    cse_p563_t1_g89059 = (0.50000000000000000     * cse_p511_t1_g89028);
    cse_p515_t1_g89033 = (cse_p511_t136_g88980 * cse_p563_t1_g89059);
    cse_p515_t1_g89039 = (cse_p511_t138_g88982 * cse_p563_t1_g89059);
    cse_p515_t1_g89034 = (cse_p511_t139_g88983 * cse_p563_t1_g89059);
    cse_p516_t1_g89041 = (cse_p511_t141_g88985 * cse_p563_t1_g89059);
    cse_p515_t1_g89035 = (cse_p511_t142_g88986 * cse_p563_t1_g89059);
    cse_p516_t1_g89042 = (cse_p511_t144_g88988 * cse_p563_t1_g89059);
    cse_p511_t1_g89027 = (cse_p561_t2_invsqrt89048 * cse_p561_t3_sqrt89049);
    cse_p563_t1_g89058 = (0.50000000000000000     * cse_p511_t1_g89027);
    cse_p515_t1_g89037 = (cse_p511_t131_g88975 * cse_p563_t1_g89058);
    cse_p561_t5_invr89051 = (1.0 / (cse_p926_t1_g89073));
    cse_p978_t1_g89074 = (cse_p561_t5_invr89051 * cse_p561_t5_invr89051);
    cse_p511_t7_g88851 = (cse_p978_t1_g89074 * (cse_p515_t1_g89033 + cse_p515_t1_g89037));
    cse_p515_t1_g89032 = (cse_p511_t133_g88977 * cse_p563_t1_g89058);
    cse_p511_t8_g88852 = (cse_p978_t1_g89074 * (cse_p515_t1_g89032 + cse_p515_t1_g89039));
    cse_p515_t1_g89038 = (cse_p511_t134_g88978 * cse_p563_t1_g89058);
    cse_p511_t9_g88853 = (cse_p978_t1_g89074 * (cse_p515_t1_g89034 + cse_p515_t1_g89038));
    cse_p515_t1_g89030 = (cse_p511_t127_g88971 * cse_p563_t1_g89058);
    cse_p511_t10_g88854 = (cse_p978_t1_g89074 * (cse_p515_t1_g89030 + cse_p516_t1_g89041));
    cse_p515_t1_g89036 = (cse_p511_t128_g88972 * cse_p563_t1_g89058);
    cse_p511_t11_g88855 = (cse_p978_t1_g89074 * (cse_p515_t1_g89035 + cse_p515_t1_g89036));
    cse_p515_t1_g89031 = (cse_p511_t130_g88974 * cse_p563_t1_g89058);
    cse_p511_t12_g88856 = (cse_p978_t1_g89074 * (cse_p515_t1_g89031 + cse_p516_t1_g89042));
    cse_p511_t115_g88959 = (cse_p515_t1_g89033 + cse_p515_t1_g89037);
    cse_p511_t116_g88960 = (cse_p515_t1_g89032 + cse_p515_t1_g89039);
    cse_p511_t117_g88961 = (cse_p515_t1_g89034 + cse_p515_t1_g89038);
    cse_p511_t118_g88962 = (cse_p515_t1_g89030 + cse_p516_t1_g89041);
    cse_p511_t119_g88963 = (cse_p515_t1_g89035 + cse_p515_t1_g89036);
    cse_p511_t120_g88964 = (cse_p515_t1_g89031 + cse_p516_t1_g89042);
    cse_p511_t169_g89013 = (-(cse_p511_t7_g88851));
    cse_p511_t170_g89014 = (-(cse_p511_t8_g88852));
    cse_p511_t171_g89015 = (-(cse_p511_t9_g88853));
    cse_p511_t172_g89016 = (-(cse_p511_t10_g88854));
    cse_p511_t173_g89017 = (-(cse_p511_t11_g88855));
    cse_p511_t174_g89018 = (-(cse_p511_t12_g88856));
    dot_n1n2 = ((n1x * n2x) + (n1y * n2y) + (n1z * n2z));
    cse_p1030_t1_g89075 = (cse_p978_t1_g89074 * dot_n1n2);
    cse_p562_t1_g89056 = (-0.50000000000000000     * cse_p1030_t1_g89075);
    cse_p875_t1_g89071 = (cse_p511_t1_g89028 * cse_p562_t1_g89056);
    cse_p511_t19_g88863 = (cse_p511_t137_g88981 * cse_p875_t1_g89071);
    cse_p511_t20_g88864 = (cse_p511_t140_g88984 * cse_p875_t1_g89071);
    cse_p511_t21_g88865 = (cse_p511_t143_g88987 * cse_p875_t1_g89071);
    cse_p875_t1_g89070 = (cse_p511_t1_g89027 * cse_p562_t1_g89056);
    cse_p511_t22_g88866 = (cse_p511_t129_g88973 * cse_p875_t1_g89070);
    cse_p511_t23_g88867 = (cse_p511_t132_g88976 * cse_p875_t1_g89070);
    cse_p511_t24_g88868 = (cse_p511_t135_g88979 * cse_p875_t1_g89070);
    cse_p511_t55_g88899 = (cse_p511_t169_g89013 * dot_n1n2);
    cse_p511_t56_g88900 = (cse_p511_t170_g89014 * dot_n1n2);
    cse_p511_t57_g88901 = (cse_p511_t171_g89015 * dot_n1n2);
    cse_p511_t58_g88902 = (cse_p511_t172_g89016 * dot_n1n2);
    cse_p511_t59_g88903 = (cse_p511_t173_g89017 * dot_n1n2);
    cse_p511_t60_g88904 = (cse_p511_t174_g89018 * dot_n1n2);
    cse_p511_t67_g88911 = (cse_p511_t145_g88989 * cse_p561_t5_invr89051);
    cse_p511_t68_g88912 = (cse_p511_t146_g88990 * cse_p561_t5_invr89051);
    cse_p511_t69_g88913 = (cse_p511_t147_g88991 * cse_p561_t5_invr89051);
    cse_p511_t70_g88914 = (cse_p511_t148_g88992 * cse_p561_t5_invr89051);
    cse_p511_t71_g88915 = (cse_p511_t149_g88993 * cse_p561_t5_invr89051);
    cse_p511_t72_g88916 = (cse_p511_t150_g88994 * cse_p561_t5_invr89051);
    cse_p511_t73_g88917 = (cse_p511_t151_g88995 * cse_p561_t5_invr89051);
    cse_p511_t74_g88918 = (cse_p511_t152_g88996 * cse_p561_t5_invr89051);
    cse_p511_t75_g88919 = (cse_p511_t153_g88997 * cse_p561_t5_invr89051);
    cse_p511_t76_g88920 = (cse_p511_t154_g88998 * cse_p561_t5_invr89051);
    cse_p511_t77_g88921 = (cse_p511_t155_g88999 * cse_p561_t5_invr89051);
    cse_p511_t78_g88922 = (cse_p511_t156_g89000 * cse_p561_t5_invr89051);
    cse_p511_t109_g88953 = (cse_p511_t19_g88863 + cse_p511_t68_g88912);
    cse_p511_t110_g88954 = (cse_p511_t20_g88864 + cse_p511_t72_g88916);
    cse_p511_t111_g88955 = (cse_p511_t21_g88865 + cse_p511_t76_g88920);
    cse_p511_t112_g88956 = (cse_p511_t22_g88866 + cse_p511_t69_g88913);
    cse_p511_t113_g88957 = (cse_p511_t23_g88867 + cse_p511_t73_g88917);
    cse_p511_t114_g88958 = (cse_p511_t24_g88868 + cse_p511_t77_g88921);
    cse_p511_t121_g88965 = (cse_p511_t55_g88899 + cse_p511_t71_g88915);
    cse_p511_t122_g88966 = (cse_p511_t56_g88900 + cse_p511_t70_g88914);
    cse_p511_t123_g88967 = (cse_p511_t57_g88901 + cse_p511_t75_g88919);
    cse_p511_t124_g88968 = (cse_p511_t58_g88902 + cse_p511_t74_g88918);
    cse_p511_t125_g88969 = (cse_p511_t59_g88903 + cse_p511_t67_g88911);
    cse_p511_t126_g88970 = (cse_p511_t60_g88904 + cse_p511_t78_g88922);
    cosphi = (cse_p561_t5_invr89051 * dot_n1n2);
    cse_p561_t9_invsqrt89055 = (1.0 / sqrt((1.0000000000000000     + (-(((cosphi) * (cosphi)))))));
    cse_p511_t1_g88845 = (cse_p511_t109_g88953 * cse_p561_t9_invsqrt89055);
    cse_p511_t2_g88846 = (cse_p511_t110_g88954 * cse_p561_t9_invsqrt89055);
    cse_p511_t3_g88847 = (cse_p511_t111_g88955 * cse_p561_t9_invsqrt89055);
    cse_p511_t4_g88848 = (cse_p511_t112_g88956 * cse_p561_t9_invsqrt89055);
    cse_p511_t5_g88849 = (cse_p511_t113_g88957 * cse_p561_t9_invsqrt89055);
    cse_p511_t6_g88850 = (cse_p511_t114_g88958 * cse_p561_t9_invsqrt89055);
    cse_p511_t13_g88857 = (cse_p511_t121_g88965 * cse_p561_t9_invsqrt89055);
    cse_p511_t14_g88858 = (cse_p511_t122_g88966 * cse_p561_t9_invsqrt89055);
    cse_p511_t15_g88859 = (cse_p511_t123_g88967 * cse_p561_t9_invsqrt89055);
    cse_p511_t16_g88860 = (cse_p511_t124_g88968 * cse_p561_t9_invsqrt89055);
    cse_p511_t17_g88861 = (cse_p511_t125_g88969 * cse_p561_t9_invsqrt89055);
    cse_p511_t18_g88862 = (cse_p511_t126_g88970 * cse_p561_t9_invsqrt89055);
    cse_p511_t163_g89007 = (-(cse_p511_t1_g88845));
    cse_p511_t164_g89008 = (-(cse_p511_t2_g88846));
    cse_p511_t165_g89009 = (-(cse_p511_t3_g88847));
    cse_p511_t166_g89010 = (-(cse_p511_t4_g88848));
    cse_p511_t167_g89011 = (-(cse_p511_t5_g88849));
    cse_p511_t168_g89012 = (-(cse_p511_t6_g88850));
    cse_p511_t175_g89019 = (-(cse_p511_t13_g88857));
    cse_p511_t176_g89020 = (-(cse_p511_t14_g88858));
    cse_p511_t177_g89021 = (-(cse_p511_t15_g88859));
    cse_p511_t178_g89022 = (-(cse_p511_t16_g88860));
    cse_p511_t179_g89023 = (-(cse_p511_t17_g88861));
    cse_p511_t180_g89024 = (-(cse_p511_t18_g88862));
    cse_p1_t26_g88746 = (1.0000000000000000     + (-(((cosphi) * (cosphi)))));
    cse_p1_t33_g88753 = (-(((cosphi) * (cosphi))));
    cse_p1_t44_g88764 = (1.0 / sqrt(cse_p1_t26_g88746));
    cse_p1_t45_g88765 = ((cosphi) * (cosphi));
    phi = acos(cosphi);
    deltaphi = (phi + (-(phi0)));
    cse_p2_t1_g88782 = (deltaphi * kdh);
    energy = (cse_p2_t1_g88782 * deltaphi);
    *energy_accumulate += energy;
    cse_p1_t1_g88768 = (2.0000000000000000     * cse_p2_t1_g88782);
    cse_p1_t1_g88771 = cse_p562_t1_g89056;
    cse_p2_t1_g88780 = (cse_p1_t1_g88771 * cse_p511_t1_g89027);
    cse_p52_t1_g88789 = (cse_p1_t1_g88768 * cse_p1_t44_g88764);
    g_x1 = (-((cse_p52_t1_g88789 * (cse_p511_t77_g88921 + (cse_p2_t1_g88780 * cse_p511_t135_g88979)))));
    KernelGradientAcc(i3x1, 0, g_x1);
    g_y1 = (-((cse_p52_t1_g88789 * ((cse_p2_t1_g88780 * (cse_p1_t2_g88722 + cse_p1_t2_g88722 + cse_p511_t39_g88883)) + (cse_p561_t5_invr89051 * (cse_p1_t3_g88723 + cse_p511_t98_g88942))))));
    KernelGradientAcc(i3x1, 1, g_y1);
    g_z1 = (-((cse_p52_t1_g88789 * (cse_p511_t73_g88917 + (cse_p2_t1_g88780 * cse_p511_t132_g88976)))));
    KernelGradientAcc(i3x1, 2, g_z1);
    g_x2 = (-((cse_p52_t1_g88789 * (cse_p511_t78_g88922 + (-((cse_p1030_t1_g89075 * cse_p511_t120_g88964)))))));
    KernelGradientAcc(i3x2, 0, g_x2);
    g_y2 = (-((cse_p52_t1_g88789 * (cse_p511_t70_g88914 + (-((cse_p1030_t1_g89075 * (cse_p515_t1_g89032 + (cse_p563_t1_g89059 * (cse_p1_t4_g88724 + cse_p1_t4_g88724 + cse_p511_t48_g88892))))))))));
    KernelGradientAcc(i3x2, 1, g_y2);
    g_z2 = (-((cse_p52_t1_g88789 * (cse_p511_t74_g88918 + (-((cse_p1030_t1_g89075 * cse_p511_t118_g88962)))))));
    KernelGradientAcc(i3x2, 2, g_z2);
    g_x3 = (-((cse_p52_t1_g88789 * (cse_p511_t75_g88919 + (-((cse_p1030_t1_g89075 * cse_p511_t117_g88961)))))));
    KernelGradientAcc(i3x3, 0, g_x3);
    g_y3 = (-((cse_p52_t1_g88789 * (cse_p511_t67_g88911 + (-((cse_p1030_t1_g89075 * (cse_p515_t1_g89035 + (cse_p563_t1_g89058 * (cse_p1_t1_g88721 + cse_p1_t1_g88721 + cse_p511_t38_g88882))))))))));
    KernelGradientAcc(i3x3, 1, g_y3);
    g_z3 = (-((cse_p52_t1_g88789 * (cse_p511_t71_g88915 + (-((cse_p1030_t1_g89075 * cse_p511_t115_g88959)))))));
    KernelGradientAcc(i3x3, 2, g_z3);
    cse_p2_t1_g88781 = (cse_p1_t1_g88771 * cse_p511_t1_g89028);
    g_x4 = (-((cse_p52_t1_g88789 * (cse_p511_t76_g88920 + (cse_p2_t1_g88781 * cse_p511_t143_g88987)))));
    KernelGradientAcc(i3x4, 0, g_x4);
    g_y4 = (-((cse_p52_t1_g88789 * ((cse_p2_t1_g88781 * (cse_p1_t3_g88723 + cse_p1_t3_g88723 + cse_p511_t47_g88891)) + (cse_p561_t5_invr89051 * (cse_p1_t2_g88722 + cse_p511_t82_g88926))))));
    KernelGradientAcc(i3x4, 1, g_y4);
    g_z4 = (-((cse_p52_t1_g88789 * (cse_p511_t72_g88916 + (cse_p2_t1_g88781 * cse_p511_t140_g88984)))));
    KernelGradientAcc(i3x4, 2, g_z4);
    cse_p512_t1_g89029 = (2.0000000000000000     * kdh);
    cse_p563_t1_g89057 = (cse_p511_t168_g89012 * cse_p512_t1_g89029);
    h_x1_x1 = (cse_p511_t168_g89012 * cse_p563_t1_g89057);
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 0, i3x1, 0, h_x1_x1);
    cse_p516_t1_g89045 = (cse_p511_t166_g89010 * cse_p512_t1_g89029);
    h_x1_y1 = (cse_p511_t168_g89012 * cse_p516_t1_g89045);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 0, i3x1, 1, h_x1_y1);
    cse_p516_t1_g89046 = (cse_p511_t167_g89011 * cse_p512_t1_g89029);
    h_x1_z1 = (cse_p511_t168_g89012 * cse_p516_t1_g89046);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 0, i3x1, 2, h_x1_z1);
    h_x1_x2 = (cse_p511_t180_g89024 * cse_p563_t1_g89057);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 0, i3x2, 0, h_x1_x2);
    h_x1_y2 = (cse_p511_t176_g89020 * cse_p563_t1_g89057);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 0, i3x2, 1, h_x1_y2);
    h_x1_z2 = (cse_p511_t178_g89022 * cse_p563_t1_g89057);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 0, i3x2, 2, h_x1_z2);
    h_x1_x3 = (cse_p511_t177_g89021 * cse_p563_t1_g89057);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 0, i3x3, 0, h_x1_x3);
    h_x1_y3 = (cse_p511_t179_g89023 * cse_p563_t1_g89057);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 0, i3x3, 1, h_x1_y3);
    h_x1_z3 = (cse_p511_t175_g89019 * cse_p563_t1_g89057);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 0, i3x3, 2, h_x1_z3);
    cse_p516_t1_g89044 = (cse_p511_t165_g89009 * cse_p512_t1_g89029);
    h_x1_x4 = (cse_p511_t168_g89012 * cse_p516_t1_g89044);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 0, i3x4, 0, h_x1_x4);
    cse_p516_t1_g89040 = (cse_p511_t163_g89007 * cse_p512_t1_g89029);
    h_x1_y4 = (cse_p511_t168_g89012 * cse_p516_t1_g89040);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 0, i3x4, 1, h_x1_y4);
    cse_p516_t1_g89043 = (cse_p511_t164_g89008 * cse_p512_t1_g89029);
    h_x1_z4 = (cse_p511_t168_g89012 * cse_p516_t1_g89043);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 0, i3x4, 2, h_x1_z4);
    h_y1_y1 = (cse_p511_t166_g89010 * cse_p516_t1_g89045);
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 1, i3x1, 1, h_y1_y1);
    h_y1_z1 = (cse_p511_t167_g89011 * cse_p516_t1_g89045);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 1, i3x1, 2, h_y1_z1);
    h_y1_x2 = (cse_p511_t180_g89024 * cse_p516_t1_g89045);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 1, i3x2, 0, h_y1_x2);
    h_y1_y2 = (cse_p511_t176_g89020 * cse_p516_t1_g89045);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 1, i3x2, 1, h_y1_y2);
    h_y1_z2 = (cse_p511_t178_g89022 * cse_p516_t1_g89045);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 1, i3x2, 2, h_y1_z2);
    h_y1_x3 = (cse_p511_t177_g89021 * cse_p516_t1_g89045);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 1, i3x3, 0, h_y1_x3);
    h_y1_y3 = (cse_p511_t179_g89023 * cse_p516_t1_g89045);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 1, i3x3, 1, h_y1_y3);
    h_y1_z3 = (cse_p511_t175_g89019 * cse_p516_t1_g89045);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 1, i3x3, 2, h_y1_z3);
    h_y1_x4 = (cse_p511_t166_g89010 * cse_p516_t1_g89044);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 1, i3x4, 0, h_y1_x4);
    h_y1_y4 = (cse_p511_t166_g89010 * cse_p516_t1_g89040);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 1, i3x4, 1, h_y1_y4);
    h_y1_z4 = (cse_p511_t166_g89010 * cse_p516_t1_g89043);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 1, i3x4, 2, h_y1_z4);
    h_z1_z1 = (cse_p511_t167_g89011 * cse_p516_t1_g89046);
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 2, i3x1, 2, h_z1_z1);
    h_z1_x2 = (cse_p511_t180_g89024 * cse_p516_t1_g89046);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 2, i3x2, 0, h_z1_x2);
    h_z1_y2 = (cse_p511_t176_g89020 * cse_p516_t1_g89046);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 2, i3x2, 1, h_z1_y2);
    h_z1_z2 = (cse_p511_t178_g89022 * cse_p516_t1_g89046);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 2, i3x2, 2, h_z1_z2);
    h_z1_x3 = (cse_p511_t177_g89021 * cse_p516_t1_g89046);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 2, i3x3, 0, h_z1_x3);
    h_z1_y3 = (cse_p511_t179_g89023 * cse_p516_t1_g89046);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 2, i3x3, 1, h_z1_y3);
    h_z1_z3 = (cse_p511_t175_g89019 * cse_p516_t1_g89046);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 2, i3x3, 2, h_z1_z3);
    h_z1_x4 = (cse_p511_t167_g89011 * cse_p516_t1_g89044);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 2, i3x4, 0, h_z1_x4);
    h_z1_y4 = (cse_p511_t167_g89011 * cse_p516_t1_g89040);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 2, i3x4, 1, h_z1_y4);
    h_z1_z4 = (cse_p511_t167_g89011 * cse_p516_t1_g89043);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 2, i3x4, 2, h_z1_z4);
    h_x2_x2 = (cse_p511_t180_g89024 * cse_p511_t180_g89024 * cse_p512_t1_g89029);
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 0, i3x2, 0, h_x2_x2);
    cse_p667_t1_g89063 = (cse_p511_t176_g89020 * cse_p512_t1_g89029);
    h_x2_y2 = (cse_p511_t180_g89024 * cse_p667_t1_g89063);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 0, i3x2, 1, h_x2_y2);
    cse_p875_t1_g89069 = (cse_p511_t178_g89022 * cse_p512_t1_g89029);
    h_x2_z2 = (cse_p511_t180_g89024 * cse_p875_t1_g89069);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 0, i3x2, 2, h_x2_z2);
    cse_p875_t1_g89068 = (cse_p511_t177_g89021 * cse_p512_t1_g89029);
    h_x2_x3 = (cse_p511_t180_g89024 * cse_p875_t1_g89068);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 0, i3x3, 0, h_x2_x3);
    cse_p875_t1_g89072 = (cse_p511_t179_g89023 * cse_p512_t1_g89029);
    h_x2_y3 = (cse_p511_t180_g89024 * cse_p875_t1_g89072);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 0, i3x3, 1, h_x2_y3);
    cse_p667_t1_g89062 = (cse_p511_t175_g89019 * cse_p512_t1_g89029);
    h_x2_z3 = (cse_p511_t180_g89024 * cse_p667_t1_g89062);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 0, i3x3, 2, h_x2_z3);
    h_x2_x4 = (cse_p511_t180_g89024 * cse_p516_t1_g89044);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 0, i3x4, 0, h_x2_x4);
    h_x2_y4 = (cse_p511_t180_g89024 * cse_p516_t1_g89040);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 0, i3x4, 1, h_x2_y4);
    h_x2_z4 = (cse_p511_t180_g89024 * cse_p516_t1_g89043);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 0, i3x4, 2, h_x2_z4);
    h_y2_y2 = (cse_p511_t176_g89020 * cse_p667_t1_g89063);
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 1, i3x2, 1, h_y2_y2);
    h_y2_z2 = (cse_p511_t178_g89022 * cse_p667_t1_g89063);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 1, i3x2, 2, h_y2_z2);
    h_y2_x3 = (cse_p511_t177_g89021 * cse_p667_t1_g89063);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 1, i3x3, 0, h_y2_x3);
    h_y2_y3 = (cse_p511_t179_g89023 * cse_p667_t1_g89063);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 1, i3x3, 1, h_y2_y3);
    h_y2_z3 = (cse_p511_t176_g89020 * cse_p667_t1_g89062);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 1, i3x3, 2, h_y2_z3);
    h_y2_x4 = (cse_p511_t176_g89020 * cse_p516_t1_g89044);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 1, i3x4, 0, h_y2_x4);
    h_y2_y4 = (cse_p511_t176_g89020 * cse_p516_t1_g89040);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 1, i3x4, 1, h_y2_y4);
    h_y2_z4 = (cse_p511_t176_g89020 * cse_p516_t1_g89043);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 1, i3x4, 2, h_y2_z4);
    h_z2_z2 = (cse_p511_t178_g89022 * cse_p875_t1_g89069);
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 2, i3x2, 2, h_z2_z2);
    h_z2_x3 = (cse_p511_t178_g89022 * cse_p875_t1_g89068);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 2, i3x3, 0, h_z2_x3);
    h_z2_y3 = (cse_p511_t179_g89023 * cse_p875_t1_g89069);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 2, i3x3, 1, h_z2_y3);
    h_z2_z3 = (cse_p511_t178_g89022 * cse_p667_t1_g89062);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 2, i3x3, 2, h_z2_z3);
    h_z2_x4 = (cse_p511_t178_g89022 * cse_p516_t1_g89044);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 2, i3x4, 0, h_z2_x4);
    h_z2_y4 = (cse_p511_t178_g89022 * cse_p516_t1_g89040);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 2, i3x4, 1, h_z2_y4);
    h_z2_z4 = (cse_p511_t178_g89022 * cse_p516_t1_g89043);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 2, i3x4, 2, h_z2_z4);
    h_x3_x3 = (cse_p511_t177_g89021 * cse_p875_t1_g89068);
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x3, 0, i3x3, 0, h_x3_x3);
    h_x3_y3 = (cse_p511_t179_g89023 * cse_p875_t1_g89068);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x3, 0, i3x3, 1, h_x3_y3);
    h_x3_z3 = (cse_p511_t177_g89021 * cse_p667_t1_g89062);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x3, 0, i3x3, 2, h_x3_z3);
    h_x3_x4 = (cse_p511_t177_g89021 * cse_p516_t1_g89044);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x3, 0, i3x4, 0, h_x3_x4);
    h_x3_y4 = (cse_p511_t177_g89021 * cse_p516_t1_g89040);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x3, 0, i3x4, 1, h_x3_y4);
    h_x3_z4 = (cse_p511_t177_g89021 * cse_p516_t1_g89043);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x3, 0, i3x4, 2, h_x3_z4);
    h_y3_y3 = (cse_p511_t179_g89023 * cse_p875_t1_g89072);
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x3, 1, i3x3, 1, h_y3_y3);
    h_y3_z3 = (cse_p511_t179_g89023 * cse_p667_t1_g89062);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x3, 1, i3x3, 2, h_y3_z3);
    h_y3_x4 = (cse_p511_t179_g89023 * cse_p516_t1_g89044);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x3, 1, i3x4, 0, h_y3_x4);
    h_y3_y4 = (cse_p511_t179_g89023 * cse_p516_t1_g89040);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x3, 1, i3x4, 1, h_y3_y4);
    h_y3_z4 = (cse_p511_t179_g89023 * cse_p516_t1_g89043);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x3, 1, i3x4, 2, h_y3_z4);
    h_z3_z3 = (cse_p511_t175_g89019 * cse_p667_t1_g89062);
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x3, 2, i3x3, 2, h_z3_z3);
    h_z3_x4 = (cse_p511_t175_g89019 * cse_p516_t1_g89044);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x3, 2, i3x4, 0, h_z3_x4);
    h_z3_y4 = (cse_p511_t175_g89019 * cse_p516_t1_g89040);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x3, 2, i3x4, 1, h_z3_y4);
    h_z3_z4 = (cse_p511_t175_g89019 * cse_p516_t1_g89043);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x3, 2, i3x4, 2, h_z3_z4);
    h_x4_x4 = (cse_p511_t165_g89009 * cse_p516_t1_g89044);
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x4, 0, i3x4, 0, h_x4_x4);
    h_x4_y4 = (cse_p511_t165_g89009 * cse_p516_t1_g89040);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x4, 0, i3x4, 1, h_x4_y4);
    h_x4_z4 = (cse_p511_t165_g89009 * cse_p516_t1_g89043);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x4, 0, i3x4, 2, h_x4_z4);
    h_y4_y4 = (cse_p511_t163_g89007 * cse_p516_t1_g89040);
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x4, 1, i3x4, 1, h_y4_y4);
    h_y4_z4 = (cse_p511_t164_g89008 * cse_p516_t1_g89040);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x4, 1, i3x4, 2, h_y4_z4);
    h_z4_z4 = (cse_p511_t164_g89008 * cse_p516_t1_g89043);
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x4, 2, i3x4, 2, h_z4_z4);
  }
}
void hessian_fd(double kdh, double phi0, size_t i3x1, size_t i3x2, size_t i3x3, size_t i3x4, double* position, double* energy_accumulate, double* force, HESSIAN hessian, double* dvec, double* hdvec)
{
  constexpr size_t PositionSize = 12;
  const double h = 1.0e-5;
  const double inv2h = 1.0/(2.0*h);
  const double invh2 = 1.0/((h*h));
  double e0 = 0.0;
  energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e0, 0, 0, 0, 0);
  if (energy_accumulate) { *energy_accumulate += e0; }
  {
    double saved = position[i3x1 + 0];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x1 + 0] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x1 + 0] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x1 + 0] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x1, 0, d);
  }
  {
    double saved = position[i3x1 + 1];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x1 + 1] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x1 + 1] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x1 + 1] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x1, 1, d);
  }
  {
    double saved = position[i3x1 + 2];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x1 + 2] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x1 + 2] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x1 + 2] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x1, 2, d);
  }
  {
    double saved = position[i3x2 + 0];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x2 + 0] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x2 + 0] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x2 + 0] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x2, 0, d);
  }
  {
    double saved = position[i3x2 + 1];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x2 + 1] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x2 + 1] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x2 + 1] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x2, 1, d);
  }
  {
    double saved = position[i3x2 + 2];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x2 + 2] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x2 + 2] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x2 + 2] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x2, 2, d);
  }
  {
    double saved = position[i3x3 + 0];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x3 + 0] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x3 + 0] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x3 + 0] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x3, 0, d);
  }
  {
    double saved = position[i3x3 + 1];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x3 + 1] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x3 + 1] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x3 + 1] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x3, 1, d);
  }
  {
    double saved = position[i3x3 + 2];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x3 + 2] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x3 + 2] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x3 + 2] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x3, 2, d);
  }
  {
    double saved = position[i3x4 + 0];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x4 + 0] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x4 + 0] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x4 + 0] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x4, 0, d);
  }
  {
    double saved = position[i3x4 + 1];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x4 + 1] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x4 + 1] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x4 + 1] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x4, 1, d);
  }
  {
    double saved = position[i3x4 + 2];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x4 + 2] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x4 + 2] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x4 + 2] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x4, 2, d);
  }
  {
    double saved = position[i3x1 + 0];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x1 + 0] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x1 + 0] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x1 + 0] = saved;
    double hval = (e_plus + e_minus - (2.0*e0)) * invh2;
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec, i3x1, 0, i3x1, 0, hval);
  }
  {
    double saved = position[i3x1 + 1];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x1 + 1] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x1 + 1] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x1 + 1] = saved;
    double hval = (e_plus + e_minus - (2.0*e0)) * invh2;
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec, i3x1, 1, i3x1, 1, hval);
  }
  {
    double saved = position[i3x1 + 2];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x1 + 2] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x1 + 2] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x1 + 2] = saved;
    double hval = (e_plus + e_minus - (2.0*e0)) * invh2;
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec, i3x1, 2, i3x1, 2, hval);
  }
  {
    double saved = position[i3x2 + 0];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x2 + 0] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x2 + 0] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x2 + 0] = saved;
    double hval = (e_plus + e_minus - (2.0*e0)) * invh2;
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec, i3x2, 0, i3x2, 0, hval);
  }
  {
    double saved = position[i3x2 + 1];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x2 + 1] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x2 + 1] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x2 + 1] = saved;
    double hval = (e_plus + e_minus - (2.0*e0)) * invh2;
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec, i3x2, 1, i3x2, 1, hval);
  }
  {
    double saved = position[i3x2 + 2];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x2 + 2] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x2 + 2] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x2 + 2] = saved;
    double hval = (e_plus + e_minus - (2.0*e0)) * invh2;
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec, i3x2, 2, i3x2, 2, hval);
  }
  {
    double saved = position[i3x3 + 0];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x3 + 0] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x3 + 0] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x3 + 0] = saved;
    double hval = (e_plus + e_minus - (2.0*e0)) * invh2;
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 0, i3x3, 0, hval);
  }
  {
    double saved = position[i3x3 + 1];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x3 + 1] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x3 + 1] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x3 + 1] = saved;
    double hval = (e_plus + e_minus - (2.0*e0)) * invh2;
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 1, i3x3, 1, hval);
  }
  {
    double saved = position[i3x3 + 2];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x3 + 2] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x3 + 2] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x3 + 2] = saved;
    double hval = (e_plus + e_minus - (2.0*e0)) * invh2;
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 2, i3x3, 2, hval);
  }
  {
    double saved = position[i3x4 + 0];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x4 + 0] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x4 + 0] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x4 + 0] = saved;
    double hval = (e_plus + e_minus - (2.0*e0)) * invh2;
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 0, i3x4, 0, hval);
  }
  {
    double saved = position[i3x4 + 1];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x4 + 1] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x4 + 1] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x4 + 1] = saved;
    double hval = (e_plus + e_minus - (2.0*e0)) * invh2;
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 1, i3x4, 1, hval);
  }
  {
    double saved = position[i3x4 + 2];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x4 + 2] = saved + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x4 + 2] = saved - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x4 + 2] = saved;
    double hval = (e_plus + e_minus - (2.0*e0)) * invh2;
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 2, i3x4, 2, hval);
  }
  {
    double saved_i = position[i3x1 + 1];
    double saved_j = position[i3x1 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x1 + 1] = saved_i + h; position[i3x1 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_i - h; position[i3x1 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_i; position[i3x1 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x1, 1, i3x1, 0, hval);
  }
  {
    double saved_i = position[i3x1 + 2];
    double saved_j = position[i3x1 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x1 + 2] = saved_i + h; position[i3x1 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_i - h; position[i3x1 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_i; position[i3x1 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x1, 2, i3x1, 0, hval);
  }
  {
    double saved_i = position[i3x1 + 2];
    double saved_j = position[i3x1 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x1 + 2] = saved_i + h; position[i3x1 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_i - h; position[i3x1 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_i; position[i3x1 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x1, 2, i3x1, 1, hval);
  }
  {
    double saved_i = position[i3x2 + 0];
    double saved_j = position[i3x1 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x2 + 0] = saved_i + h; position[i3x1 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_i - h; position[i3x1 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_i; position[i3x1 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x2, 0, i3x1, 0, hval);
  }
  {
    double saved_i = position[i3x2 + 0];
    double saved_j = position[i3x1 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x2 + 0] = saved_i + h; position[i3x1 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_i - h; position[i3x1 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_i; position[i3x1 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x2, 0, i3x1, 1, hval);
  }
  {
    double saved_i = position[i3x2 + 0];
    double saved_j = position[i3x1 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x2 + 0] = saved_i + h; position[i3x1 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_i - h; position[i3x1 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_i; position[i3x1 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x2, 0, i3x1, 2, hval);
  }
  {
    double saved_i = position[i3x2 + 1];
    double saved_j = position[i3x1 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x2 + 1] = saved_i + h; position[i3x1 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_i - h; position[i3x1 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_i; position[i3x1 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x2, 1, i3x1, 0, hval);
  }
  {
    double saved_i = position[i3x2 + 1];
    double saved_j = position[i3x1 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x2 + 1] = saved_i + h; position[i3x1 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_i - h; position[i3x1 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_i; position[i3x1 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x2, 1, i3x1, 1, hval);
  }
  {
    double saved_i = position[i3x2 + 1];
    double saved_j = position[i3x1 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x2 + 1] = saved_i + h; position[i3x1 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_i - h; position[i3x1 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_i; position[i3x1 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x2, 1, i3x1, 2, hval);
  }
  {
    double saved_i = position[i3x2 + 1];
    double saved_j = position[i3x2 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x2 + 1] = saved_i + h; position[i3x2 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_i - h; position[i3x2 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_i; position[i3x2 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x2, 1, i3x2, 0, hval);
  }
  {
    double saved_i = position[i3x2 + 2];
    double saved_j = position[i3x1 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x2 + 2] = saved_i + h; position[i3x1 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_i - h; position[i3x1 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_i; position[i3x1 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x2, 2, i3x1, 0, hval);
  }
  {
    double saved_i = position[i3x2 + 2];
    double saved_j = position[i3x1 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x2 + 2] = saved_i + h; position[i3x1 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_i - h; position[i3x1 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_i; position[i3x1 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x2, 2, i3x1, 1, hval);
  }
  {
    double saved_i = position[i3x2 + 2];
    double saved_j = position[i3x1 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x2 + 2] = saved_i + h; position[i3x1 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_i - h; position[i3x1 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_i; position[i3x1 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x2, 2, i3x1, 2, hval);
  }
  {
    double saved_i = position[i3x2 + 2];
    double saved_j = position[i3x2 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x2 + 2] = saved_i + h; position[i3x2 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_i - h; position[i3x2 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_i; position[i3x2 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x2, 2, i3x2, 0, hval);
  }
  {
    double saved_i = position[i3x2 + 2];
    double saved_j = position[i3x2 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x2 + 2] = saved_i + h; position[i3x2 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_i - h; position[i3x2 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_i; position[i3x2 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x2, 2, i3x2, 1, hval);
  }
  {
    double saved_i = position[i3x3 + 0];
    double saved_j = position[i3x1 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 0] = saved_i + h; position[i3x1 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_i - h; position[i3x1 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_i; position[i3x1 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 0, i3x1, 0, hval);
  }
  {
    double saved_i = position[i3x3 + 0];
    double saved_j = position[i3x1 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 0] = saved_i + h; position[i3x1 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_i - h; position[i3x1 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_i; position[i3x1 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 0, i3x1, 1, hval);
  }
  {
    double saved_i = position[i3x3 + 0];
    double saved_j = position[i3x1 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 0] = saved_i + h; position[i3x1 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_i - h; position[i3x1 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_i; position[i3x1 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 0, i3x1, 2, hval);
  }
  {
    double saved_i = position[i3x3 + 0];
    double saved_j = position[i3x2 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 0] = saved_i + h; position[i3x2 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_i - h; position[i3x2 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_i; position[i3x2 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 0, i3x2, 0, hval);
  }
  {
    double saved_i = position[i3x3 + 0];
    double saved_j = position[i3x2 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 0] = saved_i + h; position[i3x2 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_i - h; position[i3x2 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_i; position[i3x2 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 0, i3x2, 1, hval);
  }
  {
    double saved_i = position[i3x3 + 0];
    double saved_j = position[i3x2 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 0] = saved_i + h; position[i3x2 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_i - h; position[i3x2 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_i; position[i3x2 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 0, i3x2, 2, hval);
  }
  {
    double saved_i = position[i3x3 + 1];
    double saved_j = position[i3x1 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 1] = saved_i + h; position[i3x1 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_i - h; position[i3x1 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_i; position[i3x1 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 1, i3x1, 0, hval);
  }
  {
    double saved_i = position[i3x3 + 1];
    double saved_j = position[i3x1 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 1] = saved_i + h; position[i3x1 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_i - h; position[i3x1 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_i; position[i3x1 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 1, i3x1, 1, hval);
  }
  {
    double saved_i = position[i3x3 + 1];
    double saved_j = position[i3x1 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 1] = saved_i + h; position[i3x1 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_i - h; position[i3x1 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_i; position[i3x1 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 1, i3x1, 2, hval);
  }
  {
    double saved_i = position[i3x3 + 1];
    double saved_j = position[i3x2 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 1] = saved_i + h; position[i3x2 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_i - h; position[i3x2 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_i; position[i3x2 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 1, i3x2, 0, hval);
  }
  {
    double saved_i = position[i3x3 + 1];
    double saved_j = position[i3x2 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 1] = saved_i + h; position[i3x2 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_i - h; position[i3x2 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_i; position[i3x2 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 1, i3x2, 1, hval);
  }
  {
    double saved_i = position[i3x3 + 1];
    double saved_j = position[i3x2 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 1] = saved_i + h; position[i3x2 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_i - h; position[i3x2 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_i; position[i3x2 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 1, i3x2, 2, hval);
  }
  {
    double saved_i = position[i3x3 + 1];
    double saved_j = position[i3x3 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 1] = saved_i + h; position[i3x3 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_i - h; position[i3x3 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_i; position[i3x3 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 1, i3x3, 0, hval);
  }
  {
    double saved_i = position[i3x3 + 2];
    double saved_j = position[i3x1 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 2] = saved_i + h; position[i3x1 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i - h; position[i3x1 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i; position[i3x1 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 2, i3x1, 0, hval);
  }
  {
    double saved_i = position[i3x3 + 2];
    double saved_j = position[i3x1 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 2] = saved_i + h; position[i3x1 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i - h; position[i3x1 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i; position[i3x1 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 2, i3x1, 1, hval);
  }
  {
    double saved_i = position[i3x3 + 2];
    double saved_j = position[i3x1 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 2] = saved_i + h; position[i3x1 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i - h; position[i3x1 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i; position[i3x1 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 2, i3x1, 2, hval);
  }
  {
    double saved_i = position[i3x3 + 2];
    double saved_j = position[i3x2 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 2] = saved_i + h; position[i3x2 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i - h; position[i3x2 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i; position[i3x2 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 2, i3x2, 0, hval);
  }
  {
    double saved_i = position[i3x3 + 2];
    double saved_j = position[i3x2 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 2] = saved_i + h; position[i3x2 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i - h; position[i3x2 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i; position[i3x2 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 2, i3x2, 1, hval);
  }
  {
    double saved_i = position[i3x3 + 2];
    double saved_j = position[i3x2 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 2] = saved_i + h; position[i3x2 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i - h; position[i3x2 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i; position[i3x2 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 2, i3x2, 2, hval);
  }
  {
    double saved_i = position[i3x3 + 2];
    double saved_j = position[i3x3 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 2] = saved_i + h; position[i3x3 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i - h; position[i3x3 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i; position[i3x3 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 2, i3x3, 0, hval);
  }
  {
    double saved_i = position[i3x3 + 2];
    double saved_j = position[i3x3 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 2] = saved_i + h; position[i3x3 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i - h; position[i3x3 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i; position[i3x3 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 2, i3x3, 1, hval);
  }
  {
    double saved_i = position[i3x4 + 0];
    double saved_j = position[i3x1 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 0] = saved_i + h; position[i3x1 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i - h; position[i3x1 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i; position[i3x1 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 0, i3x1, 0, hval);
  }
  {
    double saved_i = position[i3x4 + 0];
    double saved_j = position[i3x1 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 0] = saved_i + h; position[i3x1 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i - h; position[i3x1 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i; position[i3x1 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 0, i3x1, 1, hval);
  }
  {
    double saved_i = position[i3x4 + 0];
    double saved_j = position[i3x1 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 0] = saved_i + h; position[i3x1 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i - h; position[i3x1 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i; position[i3x1 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 0, i3x1, 2, hval);
  }
  {
    double saved_i = position[i3x4 + 0];
    double saved_j = position[i3x2 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 0] = saved_i + h; position[i3x2 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i - h; position[i3x2 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i; position[i3x2 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 0, i3x2, 0, hval);
  }
  {
    double saved_i = position[i3x4 + 0];
    double saved_j = position[i3x2 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 0] = saved_i + h; position[i3x2 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i - h; position[i3x2 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i; position[i3x2 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 0, i3x2, 1, hval);
  }
  {
    double saved_i = position[i3x4 + 0];
    double saved_j = position[i3x2 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 0] = saved_i + h; position[i3x2 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i - h; position[i3x2 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i; position[i3x2 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 0, i3x2, 2, hval);
  }
  {
    double saved_i = position[i3x4 + 0];
    double saved_j = position[i3x3 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 0] = saved_i + h; position[i3x3 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i - h; position[i3x3 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i; position[i3x3 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 0, i3x3, 0, hval);
  }
  {
    double saved_i = position[i3x4 + 0];
    double saved_j = position[i3x3 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 0] = saved_i + h; position[i3x3 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i - h; position[i3x3 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i; position[i3x3 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 0, i3x3, 1, hval);
  }
  {
    double saved_i = position[i3x4 + 0];
    double saved_j = position[i3x3 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 0] = saved_i + h; position[i3x3 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i - h; position[i3x3 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i; position[i3x3 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 0, i3x3, 2, hval);
  }
  {
    double saved_i = position[i3x4 + 1];
    double saved_j = position[i3x1 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 1] = saved_i + h; position[i3x1 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i - h; position[i3x1 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i; position[i3x1 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 1, i3x1, 0, hval);
  }
  {
    double saved_i = position[i3x4 + 1];
    double saved_j = position[i3x1 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 1] = saved_i + h; position[i3x1 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i - h; position[i3x1 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i; position[i3x1 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 1, i3x1, 1, hval);
  }
  {
    double saved_i = position[i3x4 + 1];
    double saved_j = position[i3x1 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 1] = saved_i + h; position[i3x1 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i - h; position[i3x1 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i; position[i3x1 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 1, i3x1, 2, hval);
  }
  {
    double saved_i = position[i3x4 + 1];
    double saved_j = position[i3x2 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 1] = saved_i + h; position[i3x2 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i - h; position[i3x2 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i; position[i3x2 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 1, i3x2, 0, hval);
  }
  {
    double saved_i = position[i3x4 + 1];
    double saved_j = position[i3x2 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 1] = saved_i + h; position[i3x2 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i - h; position[i3x2 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i; position[i3x2 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 1, i3x2, 1, hval);
  }
  {
    double saved_i = position[i3x4 + 1];
    double saved_j = position[i3x2 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 1] = saved_i + h; position[i3x2 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i - h; position[i3x2 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i; position[i3x2 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 1, i3x2, 2, hval);
  }
  {
    double saved_i = position[i3x4 + 1];
    double saved_j = position[i3x3 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 1] = saved_i + h; position[i3x3 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i - h; position[i3x3 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i; position[i3x3 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 1, i3x3, 0, hval);
  }
  {
    double saved_i = position[i3x4 + 1];
    double saved_j = position[i3x3 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 1] = saved_i + h; position[i3x3 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i - h; position[i3x3 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i; position[i3x3 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 1, i3x3, 1, hval);
  }
  {
    double saved_i = position[i3x4 + 1];
    double saved_j = position[i3x3 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 1] = saved_i + h; position[i3x3 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i - h; position[i3x3 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i; position[i3x3 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 1, i3x3, 2, hval);
  }
  {
    double saved_i = position[i3x4 + 1];
    double saved_j = position[i3x4 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 1] = saved_i + h; position[i3x4 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i - h; position[i3x4 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i; position[i3x4 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 1, i3x4, 0, hval);
  }
  {
    double saved_i = position[i3x4 + 2];
    double saved_j = position[i3x1 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 2] = saved_i + h; position[i3x1 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i - h; position[i3x1 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i; position[i3x1 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 2, i3x1, 0, hval);
  }
  {
    double saved_i = position[i3x4 + 2];
    double saved_j = position[i3x1 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 2] = saved_i + h; position[i3x1 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i - h; position[i3x1 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i; position[i3x1 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 2, i3x1, 1, hval);
  }
  {
    double saved_i = position[i3x4 + 2];
    double saved_j = position[i3x1 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 2] = saved_i + h; position[i3x1 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i - h; position[i3x1 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i; position[i3x1 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 2, i3x1, 2, hval);
  }
  {
    double saved_i = position[i3x4 + 2];
    double saved_j = position[i3x2 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 2] = saved_i + h; position[i3x2 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i - h; position[i3x2 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i; position[i3x2 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 2, i3x2, 0, hval);
  }
  {
    double saved_i = position[i3x4 + 2];
    double saved_j = position[i3x2 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 2] = saved_i + h; position[i3x2 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i - h; position[i3x2 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i; position[i3x2 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 2, i3x2, 1, hval);
  }
  {
    double saved_i = position[i3x4 + 2];
    double saved_j = position[i3x2 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 2] = saved_i + h; position[i3x2 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i - h; position[i3x2 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i; position[i3x2 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 2, i3x2, 2, hval);
  }
  {
    double saved_i = position[i3x4 + 2];
    double saved_j = position[i3x3 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 2] = saved_i + h; position[i3x3 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i - h; position[i3x3 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i; position[i3x3 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 2, i3x3, 0, hval);
  }
  {
    double saved_i = position[i3x4 + 2];
    double saved_j = position[i3x3 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 2] = saved_i + h; position[i3x3 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i - h; position[i3x3 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i; position[i3x3 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 2, i3x3, 1, hval);
  }
  {
    double saved_i = position[i3x4 + 2];
    double saved_j = position[i3x3 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 2] = saved_i + h; position[i3x3 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i - h; position[i3x3 + 2] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i; position[i3x3 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 2, i3x3, 2, hval);
  }
  {
    double saved_i = position[i3x4 + 2];
    double saved_j = position[i3x4 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 2] = saved_i + h; position[i3x4 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i - h; position[i3x4 + 0] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i; position[i3x4 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 2, i3x4, 0, hval);
  }
  {
    double saved_i = position[i3x4 + 2];
    double saved_j = position[i3x4 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 2] = saved_i + h; position[i3x4 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i - h; position[i3x4 + 1] = saved_j + h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_j - h;
    energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i; position[i3x4 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 2, i3x4, 1, hval);
  }
}

};
