void dihedral_restraint_hessian(double kdh, double phi0, size_t i3x1, size_t i3x2, size_t i3x3, size_t i3x4, double* position, double* energy_accumulate, double* force, double* hessian, double* dvec, double* hdvec) {
  constexpr size_t PositionSize = 12;
  /* !BASE */
  double cosphi;
  double cse_p1010_t1_g53361;
  double cse_p1_t10_g53092;
  double cse_p1_t11_g53093;
  double cse_p1_t12_g53094;
  double cse_p1_t1_g53083;
  double cse_p1_t1_g53130;
  double cse_p1_t1_g53133;
  double cse_p1_t26_g53108;
  double cse_p1_t27_g53109;
  double cse_p1_t28_g53110;
  double cse_p1_t29_g53111;
  double cse_p1_t2_g53084;
  double cse_p1_t30_g53112;
  double cse_p1_t31_g53113;
  double cse_p1_t32_g53114;
  double cse_p1_t33_g53115;
  double cse_p1_t34_g53116;
  double cse_p1_t35_g53117;
  double cse_p1_t36_g53118;
  double cse_p1_t37_g53119;
  double cse_p1_t38_g53120;
  double cse_p1_t39_g53121;
  double cse_p1_t3_g53085;
  double cse_p1_t40_g53122;
  double cse_p1_t41_g53123;
  double cse_p1_t42_g53124;
  double cse_p1_t44_g53126;
  double cse_p1_t45_g53127;
  double cse_p1_t46_g53128;
  double cse_p1_t47_g53129;
  double cse_p1_t4_g53086;
  double cse_p1_t5_g53087;
  double cse_p1_t6_g53088;
  double cse_p1_t7_g53089;
  double cse_p1_t8_g53090;
  double cse_p1_t9_g53091;
  double cse_p2_t1_g53142;
  double cse_p2_t1_g53143;
  double cse_p2_t1_g53144;
  double cse_p501_t100_g53246;
  double cse_p501_t101_g53247;
  double cse_p501_t102_g53248;
  double cse_p501_t103_g53249;
  double cse_p501_t104_g53250;
  double cse_p501_t105_g53251;
  double cse_p501_t106_g53252;
  double cse_p501_t107_g53253;
  double cse_p501_t108_g53254;
  double cse_p501_t109_g53255;
  double cse_p501_t10_g53156;
  double cse_p501_t110_g53256;
  double cse_p501_t111_g53257;
  double cse_p501_t112_g53258;
  double cse_p501_t113_g53259;
  double cse_p501_t114_g53260;
  double cse_p501_t115_g53261;
  double cse_p501_t116_g53262;
  double cse_p501_t117_g53263;
  double cse_p501_t118_g53264;
  double cse_p501_t119_g53265;
  double cse_p501_t11_g53157;
  double cse_p501_t120_g53266;
  double cse_p501_t121_g53267;
  double cse_p501_t122_g53268;
  double cse_p501_t123_g53269;
  double cse_p501_t124_g53270;
  double cse_p501_t125_g53271;
  double cse_p501_t126_g53272;
  double cse_p501_t127_g53273;
  double cse_p501_t128_g53274;
  double cse_p501_t129_g53275;
  double cse_p501_t12_g53158;
  double cse_p501_t130_g53276;
  double cse_p501_t131_g53277;
  double cse_p501_t132_g53278;
  double cse_p501_t133_g53279;
  double cse_p501_t134_g53280;
  double cse_p501_t135_g53281;
  double cse_p501_t136_g53282;
  double cse_p501_t137_g53283;
  double cse_p501_t138_g53284;
  double cse_p501_t139_g53285;
  double cse_p501_t13_g53159;
  double cse_p501_t140_g53286;
  double cse_p501_t141_g53287;
  double cse_p501_t142_g53288;
  double cse_p501_t143_g53289;
  double cse_p501_t144_g53290;
  double cse_p501_t145_g53291;
  double cse_p501_t146_g53292;
  double cse_p501_t147_g53293;
  double cse_p501_t148_g53294;
  double cse_p501_t149_g53295;
  double cse_p501_t14_g53160;
  double cse_p501_t150_g53296;
  double cse_p501_t151_g53297;
  double cse_p501_t152_g53298;
  double cse_p501_t153_g53299;
  double cse_p501_t154_g53300;
  double cse_p501_t155_g53301;
  double cse_p501_t156_g53302;
  double cse_p501_t157_g53303;
  double cse_p501_t158_g53304;
  double cse_p501_t159_g53305;
  double cse_p501_t15_g53161;
  double cse_p501_t160_g53306;
  double cse_p501_t161_g53307;
  double cse_p501_t162_g53308;
  double cse_p501_t163_g53309;
  double cse_p501_t164_g53310;
  double cse_p501_t165_g53311;
  double cse_p501_t166_g53312;
  double cse_p501_t167_g53313;
  double cse_p501_t168_g53314;
  double cse_p501_t169_g53315;
  double cse_p501_t16_g53162;
  double cse_p501_t170_g53316;
  double cse_p501_t171_g53317;
  double cse_p501_t172_g53318;
  double cse_p501_t173_g53319;
  double cse_p501_t174_g53320;
  double cse_p501_t175_g53321;
  double cse_p501_t176_g53322;
  double cse_p501_t177_g53323;
  double cse_p501_t178_g53324;
  double cse_p501_t179_g53325;
  double cse_p501_t17_g53163;
  double cse_p501_t180_g53326;
  double cse_p501_t181_g53327;
  double cse_p501_t182_g53328;
  double cse_p501_t18_g53164;
  double cse_p501_t19_g53165;
  double cse_p501_t1_g53147;
  double cse_p501_t1_g53329;
  double cse_p501_t1_g53330;
  double cse_p501_t20_g53166;
  double cse_p501_t21_g53167;
  double cse_p501_t22_g53168;
  double cse_p501_t23_g53169;
  double cse_p501_t24_g53170;
  double cse_p501_t2_g53148;
  double cse_p501_t37_g53183;
  double cse_p501_t38_g53184;
  double cse_p501_t39_g53185;
  double cse_p501_t3_g53149;
  double cse_p501_t40_g53186;
  double cse_p501_t41_g53187;
  double cse_p501_t42_g53188;
  double cse_p501_t43_g53189;
  double cse_p501_t44_g53190;
  double cse_p501_t45_g53191;
  double cse_p501_t46_g53192;
  double cse_p501_t47_g53193;
  double cse_p501_t48_g53194;
  double cse_p501_t49_g53195;
  double cse_p501_t4_g53150;
  double cse_p501_t50_g53196;
  double cse_p501_t51_g53197;
  double cse_p501_t52_g53198;
  double cse_p501_t53_g53199;
  double cse_p501_t54_g53200;
  double cse_p501_t55_g53201;
  double cse_p501_t56_g53202;
  double cse_p501_t57_g53203;
  double cse_p501_t58_g53204;
  double cse_p501_t59_g53205;
  double cse_p501_t5_g53151;
  double cse_p501_t60_g53206;
  double cse_p501_t61_g53207;
  double cse_p501_t62_g53208;
  double cse_p501_t63_g53209;
  double cse_p501_t64_g53210;
  double cse_p501_t65_g53211;
  double cse_p501_t66_g53212;
  double cse_p501_t67_g53213;
  double cse_p501_t68_g53214;
  double cse_p501_t69_g53215;
  double cse_p501_t6_g53152;
  double cse_p501_t70_g53216;
  double cse_p501_t71_g53217;
  double cse_p501_t72_g53218;
  double cse_p501_t73_g53219;
  double cse_p501_t74_g53220;
  double cse_p501_t75_g53221;
  double cse_p501_t76_g53222;
  double cse_p501_t77_g53223;
  double cse_p501_t78_g53224;
  double cse_p501_t79_g53225;
  double cse_p501_t7_g53153;
  double cse_p501_t80_g53226;
  double cse_p501_t81_g53227;
  double cse_p501_t82_g53228;
  double cse_p501_t83_g53229;
  double cse_p501_t84_g53230;
  double cse_p501_t85_g53231;
  double cse_p501_t86_g53232;
  double cse_p501_t87_g53233;
  double cse_p501_t88_g53234;
  double cse_p501_t89_g53235;
  double cse_p501_t8_g53154;
  double cse_p501_t90_g53236;
  double cse_p501_t91_g53237;
  double cse_p501_t92_g53238;
  double cse_p501_t93_g53239;
  double cse_p501_t94_g53240;
  double cse_p501_t95_g53241;
  double cse_p501_t96_g53242;
  double cse_p501_t97_g53243;
  double cse_p501_t98_g53244;
  double cse_p501_t99_g53245;
  double cse_p501_t9_g53155;
  double cse_p502_t1_g53331;
  double cse_p505_t1_g53332;
  double cse_p505_t1_g53333;
  double cse_p505_t1_g53334;
  double cse_p505_t1_g53335;
  double cse_p505_t1_g53336;
  double cse_p505_t1_g53337;
  double cse_p505_t1_g53338;
  double cse_p505_t1_g53339;
  double cse_p505_t1_g53340;
  double cse_p505_t1_g53341;
  double cse_p506_t1_g53342;
  double cse_p506_t1_g53343;
  double cse_p506_t1_g53344;
  double cse_p506_t1_g53345;
  double cse_p506_t1_g53346;
  double cse_p506_t1_g53347;
  double cse_p506_t1_g53348;
  double cse_p51_t1_g53145;
  double cse_p51_t1_g53146;
  double cse_p551_t1_g53349;
  double cse_p602_t1_g53350;
  double cse_p653_t1_g53351;
  double cse_p704_t1_g53352;
  double cse_p705_t1_g53353;
  double cse_p755_t1_g53354;
  double cse_p806_t1_g53355;
  double cse_p807_t1_g53356;
  double cse_p807_t1_g53357;
  double cse_p857_t1_g53358;
  double cse_p908_t1_g53359;
  double cse_p959_t1_g53360;
  double deltaphi;
  double dot_n1n2;
  double dx12;
  double dx23;
  double dx34;
  double dy12;
  double dy23;
  double dy34;
  double dz12;
  double dz23;
  double dz34;
  double energy;
  double g_x1;
  double g_x2;
  double g_x3;
  double g_x4;
  double g_y1;
  double g_y2;
  double g_y3;
  double g_y4;
  double g_z1;
  double g_z2;
  double g_z3;
  double g_z4;
  double h_x1_x1;
  double h_x1_x2;
  double h_x1_x3;
  double h_x1_x4;
  double h_x1_y1;
  double h_x1_y2;
  double h_x1_y3;
  double h_x1_y4;
  double h_x1_z1;
  double h_x1_z2;
  double h_x1_z3;
  double h_x1_z4;
  double h_x2_x2;
  double h_x2_x3;
  double h_x2_x4;
  double h_x2_y2;
  double h_x2_y3;
  double h_x2_y4;
  double h_x2_z2;
  double h_x2_z3;
  double h_x2_z4;
  double h_x3_x3;
  double h_x3_x4;
  double h_x3_y3;
  double h_x3_y4;
  double h_x3_z3;
  double h_x3_z4;
  double h_x4_x4;
  double h_x4_y4;
  double h_x4_z4;
  double h_y1_x2;
  double h_y1_x3;
  double h_y1_x4;
  double h_y1_y1;
  double h_y1_y2;
  double h_y1_y3;
  double h_y1_y4;
  double h_y1_z1;
  double h_y1_z2;
  double h_y1_z3;
  double h_y1_z4;
  double h_y2_x3;
  double h_y2_x4;
  double h_y2_y2;
  double h_y2_y3;
  double h_y2_y4;
  double h_y2_z2;
  double h_y2_z3;
  double h_y2_z4;
  double h_y3_x4;
  double h_y3_y3;
  double h_y3_y4;
  double h_y3_z3;
  double h_y3_z4;
  double h_y4_y4;
  double h_y4_z4;
  double h_z1_x2;
  double h_z1_x3;
  double h_z1_x4;
  double h_z1_y2;
  double h_z1_y3;
  double h_z1_y4;
  double h_z1_z1;
  double h_z1_z2;
  double h_z1_z3;
  double h_z1_z4;
  double h_z2_x3;
  double h_z2_x4;
  double h_z2_y3;
  double h_z2_y4;
  double h_z2_z2;
  double h_z2_z3;
  double h_z2_z4;
  double h_z3_x4;
  double h_z3_y4;
  double h_z3_z3;
  double h_z3_z4;
  double h_z4_z4;
  double inv_n1n2;
  double n1;
  double n1x;
  double n1y;
  double n1z;
  double n1_2;
  double n2;
  double n2x;
  double n2y;
  double n2z;
  double n2_2;
  double phi;
  double r12;
  double r12_2;
  double r23;
  double r23_2;
  double r34;
  double r34_2;
  DOUBLE x1 = position[i3x1 + 0];
  DOUBLE y1 = position[i3x1 + 1];
  DOUBLE z1 = position[i3x1 + 2];
  DOUBLE x2 = position[i3x2 + 0];
  DOUBLE y2 = position[i3x2 + 1];
  DOUBLE z2 = position[i3x2 + 2];
  DOUBLE x3 = position[i3x3 + 0];
  DOUBLE y3 = position[i3x3 + 1];
  DOUBLE z3 = position[i3x3 + 2];
  DOUBLE x4 = position[i3x4 + 0];
  DOUBLE y4 = position[i3x4 + 1];
  DOUBLE z4 = position[i3x4 + 2];
  {
    /* !BASE */
    dx12 = (x2 + (-(x1)));
    cse_p1_t34_g53116 = (-(dx12));
    dy12 = (y2 + (-(y1)));
    cse_p1_t37_g53119 = (-(dy12));
    dz12 = (z2 + (-(z1)));
    cse_p1_t40_g53122 = (-(dz12));
    dx23 = (x3 + (-(x2)));
    cse_p501_t157_g53303 = (cse_p1_t34_g53116 + (-(dx23)));
    cse_p1_t27_g53109 = (dx12 + dx23);
    cse_p1_t35_g53117 = (-(dx23));
    dy23 = (y3 + (-(y2)));
    cse_p501_t159_g53305 = (cse_p1_t37_g53119 + (-(dy23)));
    cse_p1_t29_g53111 = (dy12 + dy23);
    cse_p1_t38_g53120 = (-(dy23));
    dz23 = (z3 + (-(z2)));
    cse_p501_t161_g53307 = (cse_p1_t40_g53122 + (-(dz23)));
    cse_p1_t31_g53113 = (dz12 + dz23);
    cse_p1_t41_g53123 = (-(dz23));
    dx34 = (x4 + (-(x3)));
    cse_p501_t158_g53304 = (cse_p1_t35_g53117 + (-(dx34)));
    cse_p1_t28_g53110 = (dx23 + dx34);
    cse_p1_t36_g53118 = (-(dx34));
    dy34 = (y4 + (-(y3)));
    cse_p501_t160_g53306 = (cse_p1_t38_g53120 + (-(dy34)));
    cse_p1_t30_g53112 = (dy23 + dy34);
    cse_p1_t39_g53121 = (-(dy34));
    dz34 = (z4 + (-(z3)));
    cse_p501_t162_g53308 = (cse_p1_t41_g53123 + (-(dz34)));
    cse_p1_t32_g53114 = (dz23 + dz34);
    cse_p1_t42_g53124 = (-(dz34));
    r12_2 = ((dx12 * dx12) + (dy12 * dy12) + (dz12 * dz12));
    r23_2 = ((dx23 * dx23) + (dy23 * dy23) + (dz23 * dz23));
    r34_2 = ((dx34 * dx34) + (dy34 * dy34) + (dz34 * dz34));
    r12 = sqrt(r12_2);
    r23 = sqrt(r23_2);
    r34 = sqrt(r34_2);
    n1x = ((dy12 * dz23) + (-((dy23 * dz12))));
    cse_p857_t1_g53358 = (2.0000000000000000     * n1x);
    cse_p501_t37_g53183 = (cse_p501_t159_g53305 * cse_p857_t1_g53358);
    cse_p501_t38_g53184 = (cse_p1_t40_g53122 * cse_p857_t1_g53358);
    cse_p501_t39_g53185 = (cse_p1_t41_g53123 * cse_p857_t1_g53358);
    cse_p501_t64_g53210 = (dy34 * n1x);
    cse_p501_t79_g53225 = (cse_p501_t160_g53306 * n1x);
    cse_p501_t80_g53226 = (cse_p1_t31_g53113 * n1x);
    cse_p501_t81_g53227 = (cse_p1_t32_g53114 * n1x);
    cse_p501_t82_g53228 = (cse_p1_t41_g53123 * n1x);
    cse_p501_t83_g53229 = (cse_p1_t42_g53124 * n1x);
    cse_p1_t5_g53087 = (dy12 * n1x);
    cse_p1_t6_g53088 = (dy23 * n1x);
    n1y = ((dx23 * dz12) + (-((dx12 * dz23))));
    cse_p908_t1_g53359 = (2.0000000000000000     * n1y);
    cse_p501_t40_g53186 = (cse_p501_t161_g53307 * cse_p908_t1_g53359);
    cse_p501_t41_g53187 = (cse_p1_t34_g53116 * cse_p908_t1_g53359);
    cse_p501_t42_g53188 = (cse_p1_t35_g53117 * cse_p908_t1_g53359);
    cse_p501_t66_g53212 = (dz34 * n1y);
    cse_p501_t84_g53230 = (cse_p501_t162_g53308 * n1y);
    cse_p501_t85_g53231 = (cse_p1_t27_g53109 * n1y);
    cse_p501_t86_g53232 = (cse_p1_t28_g53110 * n1y);
    cse_p501_t87_g53233 = (cse_p1_t35_g53117 * n1y);
    cse_p501_t88_g53234 = (cse_p1_t36_g53118 * n1y);
    cse_p501_t127_g53273 = (cse_p501_t37_g53183 + cse_p501_t85_g53231 + cse_p501_t85_g53231);
    cse_p501_t131_g53277 = (cse_p1_t5_g53087 + cse_p1_t5_g53087 + cse_p501_t41_g53187);
    cse_p501_t132_g53278 = (cse_p1_t6_g53088 + cse_p1_t6_g53088 + cse_p501_t42_g53188);
    cse_p501_t150_g53296 = (cse_p1_t6_g53088 + cse_p501_t87_g53233);
    cse_p1_t9_g53091 = (dz12 * n1y);
    cse_p1_t10_g53092 = (dz23 * n1y);
    n1z = ((dx12 * dy23) + (-((dx23 * dy12))));
    cse_p755_t1_g53354 = (2.0000000000000000     * n1z);
    cse_p501_t43_g53189 = (cse_p501_t157_g53303 * cse_p755_t1_g53354);
    cse_p501_t44_g53190 = (cse_p1_t37_g53119 * cse_p755_t1_g53354);
    cse_p501_t45_g53191 = (cse_p1_t38_g53120 * cse_p755_t1_g53354);
    cse_p501_t62_g53208 = (dx34 * n1z);
    cse_p501_t89_g53235 = (cse_p501_t158_g53304 * n1z);
    cse_p501_t90_g53236 = (cse_p1_t29_g53111 * n1z);
    cse_p501_t91_g53237 = (cse_p1_t30_g53112 * n1z);
    cse_p501_t92_g53238 = (cse_p1_t38_g53120 * n1z);
    cse_p501_t93_g53239 = (cse_p1_t39_g53121 * n1z);
    cse_p501_t128_g53274 = (cse_p501_t38_g53184 + (cse_p755_t1_g53354 * dx12));
    cse_p501_t129_g53275 = (cse_p501_t39_g53185 + (cse_p755_t1_g53354 * dx23));
    cse_p501_t130_g53276 = (cse_p501_t40_g53186 + cse_p501_t90_g53236 + cse_p501_t90_g53236);
    cse_p501_t133_g53279 = (cse_p501_t43_g53189 + cse_p501_t80_g53226 + cse_p501_t80_g53226);
    cse_p501_t134_g53280 = (cse_p1_t9_g53091 + cse_p1_t9_g53091 + cse_p501_t44_g53190);
    cse_p501_t135_g53281 = (cse_p1_t10_g53092 + cse_p1_t10_g53092 + cse_p501_t45_g53191);
    cse_p501_t146_g53292 = (cse_p501_t82_g53228 + (dx23 * n1z));
    cse_p501_t154_g53300 = (cse_p1_t10_g53092 + cse_p501_t92_g53238);
    cse_p1_t1_g53083 = (dx12 * n1z);
    cse_p1_t2_g53084 = (dx23 * n1z);
    n2x = ((dy23 * dz34) + (-((dy34 * dz23))));
    cse_p959_t1_g53360 = (2.0000000000000000     * n2x);
    cse_p501_t46_g53192 = (cse_p501_t160_g53306 * cse_p959_t1_g53360);
    cse_p501_t47_g53193 = (cse_p1_t41_g53123 * cse_p959_t1_g53360);
    cse_p501_t48_g53194 = (cse_p1_t42_g53124 * cse_p959_t1_g53360);
    cse_p501_t63_g53209 = (dy12 * n2x);
    cse_p501_t94_g53240 = (cse_p501_t159_g53305 * n2x);
    cse_p501_t95_g53241 = (cse_p1_t31_g53113 * n2x);
    cse_p501_t96_g53242 = (cse_p1_t32_g53114 * n2x);
    cse_p501_t97_g53243 = (cse_p1_t40_g53122 * n2x);
    cse_p501_t98_g53244 = (cse_p1_t41_g53123 * n2x);
    cse_p1_t7_g53089 = (dy23 * n2x);
    cse_p1_t8_g53090 = (dy34 * n2x);
    n2y = ((dx34 * dz23) + (-((dx23 * dz34))));
    cse_p1010_t1_g53361 = (2.0000000000000000     * n2y);
    cse_p501_t49_g53195 = (cse_p1010_t1_g53361 * cse_p501_t162_g53308);
    cse_p501_t50_g53196 = (cse_p1010_t1_g53361 * cse_p1_t35_g53117);
    cse_p501_t51_g53197 = (cse_p1010_t1_g53361 * cse_p1_t36_g53118);
    cse_p501_t65_g53211 = (dz12 * n2y);
    cse_p501_t99_g53245 = (cse_p501_t161_g53307 * n2y);
    cse_p501_t100_g53246 = (cse_p1_t27_g53109 * n2y);
    cse_p501_t101_g53247 = (cse_p1_t28_g53110 * n2y);
    cse_p501_t102_g53248 = (cse_p1_t34_g53116 * n2y);
    cse_p501_t103_g53249 = (cse_p1_t35_g53117 * n2y);
    cse_p501_t136_g53282 = (cse_p501_t101_g53247 + cse_p501_t101_g53247 + cse_p501_t46_g53192);
    cse_p501_t140_g53286 = (cse_p1_t7_g53089 + cse_p1_t7_g53089 + cse_p501_t50_g53196);
    cse_p501_t141_g53287 = (cse_p1_t8_g53090 + cse_p1_t8_g53090 + cse_p501_t51_g53197);
    cse_p501_t149_g53295 = (cse_p501_t102_g53248 + cse_p501_t63_g53209 + cse_p501_t79_g53225 + cse_p501_t86_g53232);
    cse_p501_t151_g53297 = (cse_p1_t7_g53089 + cse_p501_t103_g53249);
    cse_p501_t152_g53298 = (cse_p501_t100_g53246 + cse_p501_t64_g53210 + cse_p501_t88_g53234 + cse_p501_t94_g53240);
    cse_p1_t11_g53093 = (dz23 * n2y);
    cse_p1_t12_g53094 = (dz34 * n2y);
    n2z = ((dx23 * dy34) + (-((dx34 * dy23))));
    cse_p806_t1_g53355 = (2.0000000000000000     * n2z);
    cse_p501_t52_g53198 = (cse_p501_t158_g53304 * cse_p806_t1_g53355);
    cse_p501_t53_g53199 = (cse_p1_t38_g53120 * cse_p806_t1_g53355);
    cse_p501_t54_g53200 = (cse_p1_t39_g53121 * cse_p806_t1_g53355);
    cse_p501_t61_g53207 = (dx12 * n2z);
    cse_p501_t104_g53250 = (cse_p501_t157_g53303 * n2z);
    cse_p501_t105_g53251 = (cse_p1_t29_g53111 * n2z);
    cse_p501_t106_g53252 = (cse_p1_t30_g53112 * n2z);
    cse_p501_t107_g53253 = (cse_p1_t37_g53119 * n2z);
    cse_p501_t108_g53254 = (cse_p1_t38_g53120 * n2z);
    cse_p501_t137_g53283 = (cse_p501_t47_g53193 + (cse_p806_t1_g53355 * dx23));
    cse_p501_t138_g53284 = (cse_p501_t48_g53194 + (cse_p806_t1_g53355 * dx34));
    cse_p501_t139_g53285 = (cse_p501_t106_g53252 + cse_p501_t106_g53252 + cse_p501_t49_g53195);
    cse_p501_t142_g53288 = (cse_p501_t52_g53198 + cse_p501_t96_g53242 + cse_p501_t96_g53242);
    cse_p501_t143_g53289 = (cse_p1_t11_g53093 + cse_p1_t11_g53093 + cse_p501_t53_g53199);
    cse_p501_t144_g53290 = (cse_p1_t12_g53094 + cse_p1_t12_g53094 + cse_p501_t54_g53200);
    cse_p501_t145_g53291 = (cse_p501_t61_g53207 + cse_p501_t81_g53227 + cse_p501_t89_g53235 + cse_p501_t97_g53243);
    cse_p501_t147_g53293 = (cse_p501_t98_g53244 + (dx23 * n2z));
    cse_p501_t148_g53294 = (cse_p501_t104_g53250 + cse_p501_t62_g53208 + cse_p501_t83_g53229 + cse_p501_t95_g53241);
    cse_p501_t153_g53299 = (cse_p501_t107_g53253 + cse_p501_t65_g53211 + cse_p501_t84_g53230 + cse_p501_t91_g53237);
    cse_p501_t155_g53301 = (cse_p1_t11_g53093 + cse_p501_t108_g53254);
    cse_p501_t156_g53302 = (cse_p501_t105_g53251 + cse_p501_t66_g53212 + cse_p501_t93_g53239 + cse_p501_t99_g53245);
    cse_p1_t3_g53085 = (dx23 * n2z);
    cse_p1_t4_g53086 = (dx34 * n2z);
    n1_2 = ((n1x * n1x) + (n1y * n1y) + (n1z * n1z));
    cse_p1_t46_g53128 = pow(n1_2, -0.50000000000000000    );
    n2_2 = ((n2x * n2x) + (n2y * n2y) + (n2z * n2z));
    cse_p1_t47_g53129 = pow(n2_2, -0.50000000000000000    );
    n1 = sqrt(n1_2);
    cse_p501_t1_g53330 = (cse_p1_t47_g53129 * n1);
    cse_p704_t1_g53352 = (0.50000000000000000     * cse_p501_t1_g53330);
    cse_p505_t1_g53335 = (cse_p501_t136_g53282 * cse_p704_t1_g53352);
    cse_p505_t1_g53341 = (cse_p501_t138_g53284 * cse_p704_t1_g53352);
    cse_p505_t1_g53336 = (cse_p501_t139_g53285 * cse_p704_t1_g53352);
    cse_p506_t1_g53343 = (cse_p501_t141_g53287 * cse_p704_t1_g53352);
    cse_p505_t1_g53337 = (cse_p501_t142_g53288 * cse_p704_t1_g53352);
    cse_p506_t1_g53344 = (cse_p501_t144_g53290 * cse_p704_t1_g53352);
    n2 = sqrt(n2_2);
    cse_p602_t1_g53350 = (n1 * n2);
    cse_p501_t1_g53329 = (cse_p1_t46_g53128 * n2);
    cse_p653_t1_g53351 = (0.50000000000000000     * cse_p501_t1_g53329);
    cse_p505_t1_g53339 = (cse_p501_t131_g53277 * cse_p653_t1_g53351);
    cse_p501_t7_g53153 = ((cse_p505_t1_g53335 + cse_p505_t1_g53339) * pow(cse_p602_t1_g53350, -2));
    cse_p505_t1_g53334 = (cse_p501_t133_g53279 * cse_p653_t1_g53351);
    cse_p501_t8_g53154 = ((cse_p505_t1_g53334 + cse_p505_t1_g53341) * pow(cse_p602_t1_g53350, -2));
    cse_p505_t1_g53340 = (cse_p501_t134_g53280 * cse_p653_t1_g53351);
    cse_p501_t9_g53155 = ((cse_p505_t1_g53336 + cse_p505_t1_g53340) * pow(cse_p602_t1_g53350, -2));
    cse_p505_t1_g53332 = (cse_p501_t127_g53273 * cse_p653_t1_g53351);
    cse_p501_t10_g53156 = ((cse_p505_t1_g53332 + cse_p506_t1_g53343) * pow(cse_p602_t1_g53350, -2));
    cse_p505_t1_g53338 = (cse_p501_t128_g53274 * cse_p653_t1_g53351);
    cse_p501_t11_g53157 = ((cse_p505_t1_g53337 + cse_p505_t1_g53338) * pow(cse_p602_t1_g53350, -2));
    cse_p505_t1_g53333 = (cse_p501_t130_g53276 * cse_p653_t1_g53351);
    cse_p501_t12_g53158 = ((cse_p505_t1_g53333 + cse_p506_t1_g53344) * pow(cse_p602_t1_g53350, -2));
    cse_p501_t115_g53261 = (cse_p505_t1_g53335 + cse_p505_t1_g53339);
    cse_p501_t116_g53262 = (cse_p505_t1_g53334 + cse_p505_t1_g53341);
    cse_p501_t117_g53263 = (cse_p505_t1_g53336 + cse_p505_t1_g53340);
    cse_p501_t118_g53264 = (cse_p505_t1_g53332 + cse_p506_t1_g53343);
    cse_p501_t119_g53265 = (cse_p505_t1_g53337 + cse_p505_t1_g53338);
    cse_p501_t120_g53266 = (cse_p505_t1_g53333 + cse_p506_t1_g53344);
    cse_p501_t169_g53315 = (-(cse_p501_t7_g53153));
    cse_p501_t170_g53316 = (-(cse_p501_t8_g53154));
    cse_p501_t171_g53317 = (-(cse_p501_t9_g53155));
    cse_p501_t172_g53318 = (-(cse_p501_t10_g53156));
    cse_p501_t173_g53319 = (-(cse_p501_t11_g53157));
    cse_p501_t174_g53320 = (-(cse_p501_t12_g53158));
    cse_p501_t181_g53327 = pow(cse_p602_t1_g53350, -2);
    dot_n1n2 = ((n1x * n2x) + (n1y * n2y) + (n1z * n2z));
    cse_p551_t1_g53349 = (-0.50000000000000000     * cse_p501_t181_g53327 * dot_n1n2);
    cse_p501_t19_g53165 = (cse_p501_t137_g53283 * cse_p501_t1_g53330 * cse_p551_t1_g53349);
    cse_p501_t20_g53166 = (cse_p501_t140_g53286 * cse_p501_t1_g53330 * cse_p551_t1_g53349);
    cse_p501_t21_g53167 = (cse_p501_t143_g53289 * cse_p501_t1_g53330 * cse_p551_t1_g53349);
    cse_p501_t22_g53168 = (cse_p501_t129_g53275 * cse_p501_t1_g53329 * cse_p551_t1_g53349);
    cse_p501_t23_g53169 = (cse_p501_t132_g53278 * cse_p501_t1_g53329 * cse_p551_t1_g53349);
    cse_p501_t24_g53170 = (cse_p501_t135_g53281 * cse_p501_t1_g53329 * cse_p551_t1_g53349);
    cse_p501_t55_g53201 = (cse_p501_t169_g53315 * dot_n1n2);
    cse_p501_t56_g53202 = (cse_p501_t170_g53316 * dot_n1n2);
    cse_p501_t57_g53203 = (cse_p501_t171_g53317 * dot_n1n2);
    cse_p501_t58_g53204 = (cse_p501_t172_g53318 * dot_n1n2);
    cse_p501_t59_g53205 = (cse_p501_t173_g53319 * dot_n1n2);
    cse_p501_t60_g53206 = (cse_p501_t174_g53320 * dot_n1n2);
    inv_n1n2 = pow(cse_p602_t1_g53350, -1);
    cse_p501_t67_g53213 = (cse_p501_t145_g53291 * inv_n1n2);
    cse_p501_t68_g53214 = (cse_p501_t146_g53292 * inv_n1n2);
    cse_p501_t69_g53215 = (cse_p501_t147_g53293 * inv_n1n2);
    cse_p501_t70_g53216 = (cse_p501_t148_g53294 * inv_n1n2);
    cse_p501_t71_g53217 = (cse_p501_t149_g53295 * inv_n1n2);
    cse_p501_t72_g53218 = (cse_p501_t150_g53296 * inv_n1n2);
    cse_p501_t73_g53219 = (cse_p501_t151_g53297 * inv_n1n2);
    cse_p501_t74_g53220 = (cse_p501_t152_g53298 * inv_n1n2);
    cse_p501_t75_g53221 = (cse_p501_t153_g53299 * inv_n1n2);
    cse_p501_t76_g53222 = (cse_p501_t154_g53300 * inv_n1n2);
    cse_p501_t77_g53223 = (cse_p501_t155_g53301 * inv_n1n2);
    cse_p501_t78_g53224 = (cse_p501_t156_g53302 * inv_n1n2);
    cse_p501_t109_g53255 = (cse_p501_t19_g53165 + cse_p501_t68_g53214);
    cse_p501_t110_g53256 = (cse_p501_t20_g53166 + cse_p501_t72_g53218);
    cse_p501_t111_g53257 = (cse_p501_t21_g53167 + cse_p501_t76_g53222);
    cse_p501_t112_g53258 = (cse_p501_t22_g53168 + cse_p501_t69_g53215);
    cse_p501_t113_g53259 = (cse_p501_t23_g53169 + cse_p501_t73_g53219);
    cse_p501_t114_g53260 = (cse_p501_t24_g53170 + cse_p501_t77_g53223);
    cse_p501_t121_g53267 = (cse_p501_t55_g53201 + cse_p501_t71_g53217);
    cse_p501_t122_g53268 = (cse_p501_t56_g53202 + cse_p501_t70_g53216);
    cse_p501_t123_g53269 = (cse_p501_t57_g53203 + cse_p501_t75_g53221);
    cse_p501_t124_g53270 = (cse_p501_t58_g53204 + cse_p501_t74_g53220);
    cse_p501_t125_g53271 = (cse_p501_t59_g53205 + cse_p501_t67_g53213);
    cse_p501_t126_g53272 = (cse_p501_t60_g53206 + cse_p501_t78_g53224);
    cosphi = (dot_n1n2 * inv_n1n2);
    cse_p501_t1_g53147 = (cse_p501_t109_g53255 * pow((1.0000000000000000     + (-(((cosphi) * (cosphi))))), -0.50000000000000000    ));
    cse_p501_t2_g53148 = (cse_p501_t110_g53256 * pow((1.0000000000000000     + (-(((cosphi) * (cosphi))))), -0.50000000000000000    ));
    cse_p501_t3_g53149 = (cse_p501_t111_g53257 * pow((1.0000000000000000     + (-(((cosphi) * (cosphi))))), -0.50000000000000000    ));
    cse_p501_t4_g53150 = (cse_p501_t112_g53258 * pow((1.0000000000000000     + (-(((cosphi) * (cosphi))))), -0.50000000000000000    ));
    cse_p501_t5_g53151 = (cse_p501_t113_g53259 * pow((1.0000000000000000     + (-(((cosphi) * (cosphi))))), -0.50000000000000000    ));
    cse_p501_t6_g53152 = (cse_p501_t114_g53260 * pow((1.0000000000000000     + (-(((cosphi) * (cosphi))))), -0.50000000000000000    ));
    cse_p501_t13_g53159 = (cse_p501_t121_g53267 * pow((1.0000000000000000     + (-(((cosphi) * (cosphi))))), -0.50000000000000000    ));
    cse_p501_t14_g53160 = (cse_p501_t122_g53268 * pow((1.0000000000000000     + (-(((cosphi) * (cosphi))))), -0.50000000000000000    ));
    cse_p501_t15_g53161 = (cse_p501_t123_g53269 * pow((1.0000000000000000     + (-(((cosphi) * (cosphi))))), -0.50000000000000000    ));
    cse_p501_t16_g53162 = (cse_p501_t124_g53270 * pow((1.0000000000000000     + (-(((cosphi) * (cosphi))))), -0.50000000000000000    ));
    cse_p501_t17_g53163 = (cse_p501_t125_g53271 * pow((1.0000000000000000     + (-(((cosphi) * (cosphi))))), -0.50000000000000000    ));
    cse_p501_t18_g53164 = (cse_p501_t126_g53272 * pow((1.0000000000000000     + (-(((cosphi) * (cosphi))))), -0.50000000000000000    ));
    cse_p501_t163_g53309 = (-(cse_p501_t1_g53147));
    cse_p501_t164_g53310 = (-(cse_p501_t2_g53148));
    cse_p501_t165_g53311 = (-(cse_p501_t3_g53149));
    cse_p501_t166_g53312 = (-(cse_p501_t4_g53150));
    cse_p501_t167_g53313 = (-(cse_p501_t5_g53151));
    cse_p501_t168_g53314 = (-(cse_p501_t6_g53152));
    cse_p501_t175_g53321 = (-(cse_p501_t13_g53159));
    cse_p501_t176_g53322 = (-(cse_p501_t14_g53160));
    cse_p501_t177_g53323 = (-(cse_p501_t15_g53161));
    cse_p501_t178_g53324 = (-(cse_p501_t16_g53162));
    cse_p501_t179_g53325 = (-(cse_p501_t17_g53163));
    cse_p501_t180_g53326 = (-(cse_p501_t18_g53164));
    cse_p501_t182_g53328 = pow((1.0000000000000000     + (-(((cosphi) * (cosphi))))), -0.50000000000000000    );
    cse_p1_t26_g53108 = (1.0000000000000000     + (-(((cosphi) * (cosphi)))));
    cse_p1_t33_g53115 = (-(((cosphi) * (cosphi))));
    cse_p1_t44_g53126 = pow(cse_p1_t26_g53108, -0.50000000000000000    );
    cse_p1_t45_g53127 = ((cosphi) * (cosphi));
    phi = acos(cosphi);
    deltaphi = (phi + (-(phi0)));
    cse_p2_t1_g53144 = (deltaphi * kdh);
    energy = (cse_p2_t1_g53144 * deltaphi);
    *energy_accumulate += energy;
    cse_p1_t1_g53130 = (2.0000000000000000     * cse_p2_t1_g53144);
    cse_p51_t1_g53146 = (cse_p501_t181_g53327 * dot_n1n2);
    cse_p1_t1_g53133 = (-0.50000000000000000     * cse_p51_t1_g53146);
    cse_p2_t1_g53142 = (cse_p1_t1_g53133 * cse_p501_t1_g53329);
    cse_p51_t1_g53145 = (cse_p1_t1_g53130 * cse_p1_t44_g53126);
    g_x1 = (-((cse_p51_t1_g53145 * (cse_p501_t77_g53223 + (cse_p2_t1_g53142 * cse_p501_t135_g53281)))));
    KernelGradientAcc(i3x1, 0, g_x1);
    g_y1 = (-((cse_p51_t1_g53145 * ((cse_p2_t1_g53142 * (cse_p1_t2_g53084 + cse_p1_t2_g53084 + cse_p501_t39_g53185)) + (inv_n1n2 * (cse_p1_t3_g53085 + cse_p501_t98_g53244))))));
    KernelGradientAcc(i3x1, 1, g_y1);
    g_z1 = (-((cse_p51_t1_g53145 * (cse_p501_t73_g53219 + (cse_p2_t1_g53142 * cse_p501_t132_g53278)))));
    KernelGradientAcc(i3x1, 2, g_z1);
    g_x2 = (-((cse_p51_t1_g53145 * (cse_p501_t78_g53224 + (-((cse_p501_t120_g53266 * cse_p51_t1_g53146)))))));
    KernelGradientAcc(i3x2, 0, g_x2);
    g_y2 = (-((cse_p51_t1_g53145 * (cse_p501_t70_g53216 + (-((cse_p51_t1_g53146 * (cse_p505_t1_g53334 + (cse_p704_t1_g53352 * (cse_p1_t4_g53086 + cse_p1_t4_g53086 + cse_p501_t48_g53194))))))))));
    KernelGradientAcc(i3x2, 1, g_y2);
    g_z2 = (-((cse_p51_t1_g53145 * (cse_p501_t74_g53220 + (-((cse_p51_t1_g53146 * (cse_p505_t1_g53332 + (cse_p501_t141_g53287 * cse_p704_t1_g53352)))))))));
    KernelGradientAcc(i3x2, 2, g_z2);
    g_x3 = (-((cse_p51_t1_g53145 * (cse_p501_t75_g53221 + (-((cse_p51_t1_g53146 * (cse_p505_t1_g53340 + (cse_p501_t139_g53285 * cse_p704_t1_g53352)))))))));
    KernelGradientAcc(i3x3, 0, g_x3);
    g_y3 = (-((cse_p51_t1_g53145 * (cse_p501_t67_g53213 + (-((cse_p51_t1_g53146 * (cse_p505_t1_g53337 + (cse_p653_t1_g53351 * (cse_p1_t1_g53083 + cse_p1_t1_g53083 + cse_p501_t38_g53184))))))))));
    KernelGradientAcc(i3x3, 1, g_y3);
    g_z3 = (-((cse_p51_t1_g53145 * (cse_p501_t71_g53217 + (-((cse_p501_t115_g53261 * cse_p51_t1_g53146)))))));
    KernelGradientAcc(i3x3, 2, g_z3);
    cse_p2_t1_g53143 = (cse_p1_t1_g53133 * cse_p501_t1_g53330);
    g_x4 = (-((cse_p51_t1_g53145 * (cse_p501_t76_g53222 + (cse_p2_t1_g53143 * cse_p501_t143_g53289)))));
    KernelGradientAcc(i3x4, 0, g_x4);
    g_y4 = (-((cse_p51_t1_g53145 * ((cse_p2_t1_g53143 * (cse_p1_t3_g53085 + cse_p1_t3_g53085 + cse_p501_t47_g53193)) + (inv_n1n2 * (cse_p1_t2_g53084 + cse_p501_t82_g53228))))));
    KernelGradientAcc(i3x4, 1, g_y4);
    g_z4 = (-((cse_p51_t1_g53145 * (cse_p501_t72_g53218 + (cse_p2_t1_g53143 * cse_p501_t140_g53286)))));
    KernelGradientAcc(i3x4, 2, g_z4);
    cse_p502_t1_g53331 = (2.0000000000000000     * kdh);
    cse_p705_t1_g53353 = (cse_p501_t168_g53314 * cse_p502_t1_g53331);
    h_x1_x1 = (cse_p501_t168_g53314 * cse_p705_t1_g53353);
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 0, i3x1, 0, h_x1_x1);
    cse_p506_t1_g53347 = (cse_p501_t166_g53312 * cse_p502_t1_g53331);
    h_x1_y1 = (cse_p501_t168_g53314 * cse_p506_t1_g53347);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 0, i3x1, 1, h_x1_y1);
    cse_p506_t1_g53348 = (cse_p501_t167_g53313 * cse_p502_t1_g53331);
    h_x1_z1 = (cse_p501_t168_g53314 * cse_p506_t1_g53348);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 0, i3x1, 2, h_x1_z1);
    h_x1_x2 = (cse_p501_t180_g53326 * cse_p705_t1_g53353);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 0, i3x2, 0, h_x1_x2);
    h_x1_y2 = (cse_p501_t176_g53322 * cse_p705_t1_g53353);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 0, i3x2, 1, h_x1_y2);
    h_x1_z2 = (cse_p501_t178_g53324 * cse_p705_t1_g53353);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 0, i3x2, 2, h_x1_z2);
    h_x1_x3 = (cse_p501_t177_g53323 * cse_p705_t1_g53353);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 0, i3x3, 0, h_x1_x3);
    h_x1_y3 = (cse_p501_t179_g53325 * cse_p705_t1_g53353);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 0, i3x3, 1, h_x1_y3);
    h_x1_z3 = (cse_p501_t175_g53321 * cse_p705_t1_g53353);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 0, i3x3, 2, h_x1_z3);
    cse_p506_t1_g53346 = (cse_p501_t165_g53311 * cse_p502_t1_g53331);
    h_x1_x4 = (cse_p501_t168_g53314 * cse_p506_t1_g53346);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 0, i3x4, 0, h_x1_x4);
    cse_p506_t1_g53342 = (cse_p501_t163_g53309 * cse_p502_t1_g53331);
    h_x1_y4 = (cse_p501_t168_g53314 * cse_p506_t1_g53342);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 0, i3x4, 1, h_x1_y4);
    cse_p506_t1_g53345 = (cse_p501_t164_g53310 * cse_p502_t1_g53331);
    h_x1_z4 = (cse_p501_t168_g53314 * cse_p506_t1_g53345);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 0, i3x4, 2, h_x1_z4);
    h_y1_y1 = (cse_p501_t166_g53312 * cse_p506_t1_g53347);
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 1, i3x1, 1, h_y1_y1);
    h_y1_z1 = (cse_p501_t167_g53313 * cse_p506_t1_g53347);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 1, i3x1, 2, h_y1_z1);
    h_y1_x2 = (cse_p501_t180_g53326 * cse_p506_t1_g53347);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 1, i3x2, 0, h_y1_x2);
    h_y1_y2 = (cse_p501_t176_g53322 * cse_p506_t1_g53347);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 1, i3x2, 1, h_y1_y2);
    h_y1_z2 = (cse_p501_t178_g53324 * cse_p506_t1_g53347);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 1, i3x2, 2, h_y1_z2);
    h_y1_x3 = (cse_p501_t177_g53323 * cse_p506_t1_g53347);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 1, i3x3, 0, h_y1_x3);
    h_y1_y3 = (cse_p501_t179_g53325 * cse_p506_t1_g53347);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 1, i3x3, 1, h_y1_y3);
    h_y1_z3 = (cse_p501_t175_g53321 * cse_p506_t1_g53347);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 1, i3x3, 2, h_y1_z3);
    h_y1_x4 = (cse_p501_t166_g53312 * cse_p506_t1_g53346);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 1, i3x4, 0, h_y1_x4);
    h_y1_y4 = (cse_p501_t166_g53312 * cse_p506_t1_g53342);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 1, i3x4, 1, h_y1_y4);
    h_y1_z4 = (cse_p501_t166_g53312 * cse_p506_t1_g53345);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 1, i3x4, 2, h_y1_z4);
    h_z1_z1 = (cse_p501_t167_g53313 * cse_p506_t1_g53348);
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 2, i3x1, 2, h_z1_z1);
    h_z1_x2 = (cse_p501_t180_g53326 * cse_p506_t1_g53348);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 2, i3x2, 0, h_z1_x2);
    h_z1_y2 = (cse_p501_t176_g53322 * cse_p506_t1_g53348);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 2, i3x2, 1, h_z1_y2);
    h_z1_z2 = (cse_p501_t178_g53324 * cse_p506_t1_g53348);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 2, i3x2, 2, h_z1_z2);
    h_z1_x3 = (cse_p501_t177_g53323 * cse_p506_t1_g53348);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 2, i3x3, 0, h_z1_x3);
    h_z1_y3 = (cse_p501_t179_g53325 * cse_p506_t1_g53348);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 2, i3x3, 1, h_z1_y3);
    h_z1_z3 = (cse_p501_t175_g53321 * cse_p506_t1_g53348);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 2, i3x3, 2, h_z1_z3);
    h_z1_x4 = (cse_p501_t167_g53313 * cse_p506_t1_g53346);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 2, i3x4, 0, h_z1_x4);
    h_z1_y4 = (cse_p501_t167_g53313 * cse_p506_t1_g53342);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 2, i3x4, 1, h_z1_y4);
    h_z1_z4 = (cse_p501_t167_g53313 * cse_p506_t1_g53345);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x1, 2, i3x4, 2, h_z1_z4);
    h_x2_x2 = (cse_p501_t180_g53326 * cse_p501_t180_g53326 * cse_p502_t1_g53331);
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 0, i3x2, 0, h_x2_x2);
    cse_p807_t1_g53357 = (cse_p501_t176_g53322 * cse_p502_t1_g53331);
    h_x2_y2 = (cse_p501_t180_g53326 * cse_p807_t1_g53357);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 0, i3x2, 1, h_x2_y2);
    h_x2_z2 = (cse_p501_t178_g53324 * cse_p501_t180_g53326 * cse_p502_t1_g53331);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 0, i3x2, 2, h_x2_z2);
    h_x2_x3 = (cse_p501_t177_g53323 * cse_p501_t180_g53326 * cse_p502_t1_g53331);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 0, i3x3, 0, h_x2_x3);
    h_x2_y3 = (cse_p501_t179_g53325 * cse_p501_t180_g53326 * cse_p502_t1_g53331);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 0, i3x3, 1, h_x2_y3);
    cse_p807_t1_g53356 = (cse_p501_t175_g53321 * cse_p502_t1_g53331);
    h_x2_z3 = (cse_p501_t180_g53326 * cse_p807_t1_g53356);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 0, i3x3, 2, h_x2_z3);
    h_x2_x4 = (cse_p501_t180_g53326 * cse_p506_t1_g53346);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 0, i3x4, 0, h_x2_x4);
    h_x2_y4 = (cse_p501_t180_g53326 * cse_p506_t1_g53342);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 0, i3x4, 1, h_x2_y4);
    h_x2_z4 = (cse_p501_t180_g53326 * cse_p506_t1_g53345);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 0, i3x4, 2, h_x2_z4);
    h_y2_y2 = (cse_p501_t176_g53322 * cse_p807_t1_g53357);
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 1, i3x2, 1, h_y2_y2);
    h_y2_z2 = (cse_p501_t178_g53324 * cse_p807_t1_g53357);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 1, i3x2, 2, h_y2_z2);
    h_y2_x3 = (cse_p501_t177_g53323 * cse_p807_t1_g53357);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 1, i3x3, 0, h_y2_x3);
    h_y2_y3 = (cse_p501_t179_g53325 * cse_p807_t1_g53357);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 1, i3x3, 1, h_y2_y3);
    h_y2_z3 = (cse_p501_t176_g53322 * cse_p807_t1_g53356);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 1, i3x3, 2, h_y2_z3);
    h_y2_x4 = (cse_p501_t176_g53322 * cse_p506_t1_g53346);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 1, i3x4, 0, h_y2_x4);
    h_y2_y4 = (cse_p501_t176_g53322 * cse_p506_t1_g53342);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 1, i3x4, 1, h_y2_y4);
    h_y2_z4 = (cse_p501_t176_g53322 * cse_p506_t1_g53345);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 1, i3x4, 2, h_y2_z4);
    h_z2_z2 = (cse_p501_t178_g53324 * cse_p501_t178_g53324 * cse_p502_t1_g53331);
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 2, i3x2, 2, h_z2_z2);
    h_z2_x3 = (cse_p501_t177_g53323 * cse_p501_t178_g53324 * cse_p502_t1_g53331);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 2, i3x3, 0, h_z2_x3);
    h_z2_y3 = (cse_p501_t178_g53324 * cse_p501_t179_g53325 * cse_p502_t1_g53331);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 2, i3x3, 1, h_z2_y3);
    h_z2_z3 = (cse_p501_t178_g53324 * cse_p807_t1_g53356);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 2, i3x3, 2, h_z2_z3);
    h_z2_x4 = (cse_p501_t178_g53324 * cse_p506_t1_g53346);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 2, i3x4, 0, h_z2_x4);
    h_z2_y4 = (cse_p501_t178_g53324 * cse_p506_t1_g53342);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 2, i3x4, 1, h_z2_y4);
    h_z2_z4 = (cse_p501_t178_g53324 * cse_p506_t1_g53345);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x2, 2, i3x4, 2, h_z2_z4);
    h_x3_x3 = (cse_p501_t177_g53323 * cse_p501_t177_g53323 * cse_p502_t1_g53331);
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x3, 0, i3x3, 0, h_x3_x3);
    h_x3_y3 = (cse_p501_t177_g53323 * cse_p501_t179_g53325 * cse_p502_t1_g53331);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x3, 0, i3x3, 1, h_x3_y3);
    h_x3_z3 = (cse_p501_t177_g53323 * cse_p807_t1_g53356);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x3, 0, i3x3, 2, h_x3_z3);
    h_x3_x4 = (cse_p501_t177_g53323 * cse_p506_t1_g53346);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x3, 0, i3x4, 0, h_x3_x4);
    h_x3_y4 = (cse_p501_t177_g53323 * cse_p506_t1_g53342);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x3, 0, i3x4, 1, h_x3_y4);
    h_x3_z4 = (cse_p501_t177_g53323 * cse_p506_t1_g53345);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x3, 0, i3x4, 2, h_x3_z4);
    h_y3_y3 = (cse_p501_t179_g53325 * cse_p501_t179_g53325 * cse_p502_t1_g53331);
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x3, 1, i3x3, 1, h_y3_y3);
    h_y3_z3 = (cse_p501_t179_g53325 * cse_p807_t1_g53356);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x3, 1, i3x3, 2, h_y3_z3);
    h_y3_x4 = (cse_p501_t179_g53325 * cse_p506_t1_g53346);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x3, 1, i3x4, 0, h_y3_x4);
    h_y3_y4 = (cse_p501_t179_g53325 * cse_p506_t1_g53342);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x3, 1, i3x4, 1, h_y3_y4);
    h_y3_z4 = (cse_p501_t179_g53325 * cse_p506_t1_g53345);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x3, 1, i3x4, 2, h_y3_z4);
    h_z3_z3 = (cse_p501_t175_g53321 * cse_p807_t1_g53356);
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x3, 2, i3x3, 2, h_z3_z3);
    h_z3_x4 = (cse_p501_t175_g53321 * cse_p506_t1_g53346);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x3, 2, i3x4, 0, h_z3_x4);
    h_z3_y4 = (cse_p501_t175_g53321 * cse_p506_t1_g53342);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x3, 2, i3x4, 1, h_z3_y4);
    h_z3_z4 = (cse_p501_t175_g53321 * cse_p506_t1_g53345);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x3, 2, i3x4, 2, h_z3_z4);
    h_x4_x4 = (cse_p501_t165_g53311 * cse_p506_t1_g53346);
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x4, 0, i3x4, 0, h_x4_x4);
    h_x4_y4 = (cse_p501_t165_g53311 * cse_p506_t1_g53342);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x4, 0, i3x4, 1, h_x4_y4);
    h_x4_z4 = (cse_p501_t165_g53311 * cse_p506_t1_g53345);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x4, 0, i3x4, 2, h_x4_z4);
    h_y4_y4 = (cse_p501_t163_g53309 * cse_p506_t1_g53342);
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x4, 1, i3x4, 1, h_y4_y4);
    h_y4_z4 = (cse_p501_t164_g53310 * cse_p506_t1_g53342);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x4, 1, i3x4, 2, h_y4_z4);
    h_z4_z4 = (cse_p501_t164_g53310 * cse_p506_t1_g53345);
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec,  i3x4, 2, i3x4, 2, h_z4_z4);
  }
}
void dihedral_restraint_hessian_fd(double kdh, double phi0, size_t i3x1, size_t i3x2, size_t i3x3, size_t i3x4, double* position, double* energy_accumulate, double* force, double* hessian, double* dvec, double* hdvec)
{
  constexpr size_t PositionSize = 12;
  const double h = 1.0e-5;
  const double inv2h = 1.0/(2.0*h);
  const double invh2 = 1.0/((h*h));
  double e0 = 0.0;
  dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e0, 0, 0, 0, 0);
  if (energy_accumulate) { *energy_accumulate += e0; }
  {
    double saved = position[i3x1 + 0];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x1 + 0] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x1 + 0] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x1 + 0] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x1, 0, d);
  }
  {
    double saved = position[i3x1 + 1];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x1 + 1] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x1 + 1] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x1 + 1] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x1, 1, d);
  }
  {
    double saved = position[i3x1 + 2];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x1 + 2] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x1 + 2] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x1 + 2] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x1, 2, d);
  }
  {
    double saved = position[i3x2 + 0];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x2 + 0] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x2 + 0] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x2 + 0] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x2, 0, d);
  }
  {
    double saved = position[i3x2 + 1];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x2 + 1] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x2 + 1] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x2 + 1] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x2, 1, d);
  }
  {
    double saved = position[i3x2 + 2];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x2 + 2] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x2 + 2] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x2 + 2] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x2, 2, d);
  }
  {
    double saved = position[i3x3 + 0];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x3 + 0] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x3 + 0] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x3 + 0] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x3, 0, d);
  }
  {
    double saved = position[i3x3 + 1];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x3 + 1] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x3 + 1] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x3 + 1] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x3, 1, d);
  }
  {
    double saved = position[i3x3 + 2];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x3 + 2] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x3 + 2] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x3 + 2] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x3, 2, d);
  }
  {
    double saved = position[i3x4 + 0];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x4 + 0] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x4 + 0] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x4 + 0] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x4, 0, d);
  }
  {
    double saved = position[i3x4 + 1];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x4 + 1] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x4 + 1] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x4 + 1] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x4, 1, d);
  }
  {
    double saved = position[i3x4 + 2];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x4 + 2] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x4 + 2] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x4 + 2] = saved;
    double d = (e_plus - e_minus) * inv2h;
    KernelGradientAcc(i3x4, 2, d);
  }
  {
    double saved = position[i3x1 + 0];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x1 + 0] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x1 + 0] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x1 + 0] = saved;
    double hval = (e_plus + e_minus - (2.0*e0)) * invh2;
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec, i3x1, 0, i3x1, 0, hval);
  }
  {
    double saved = position[i3x1 + 1];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x1 + 1] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x1 + 1] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x1 + 1] = saved;
    double hval = (e_plus + e_minus - (2.0*e0)) * invh2;
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec, i3x1, 1, i3x1, 1, hval);
  }
  {
    double saved = position[i3x1 + 2];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x1 + 2] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x1 + 2] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x1 + 2] = saved;
    double hval = (e_plus + e_minus - (2.0*e0)) * invh2;
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec, i3x1, 2, i3x1, 2, hval);
  }
  {
    double saved = position[i3x2 + 0];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x2 + 0] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x2 + 0] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x2 + 0] = saved;
    double hval = (e_plus + e_minus - (2.0*e0)) * invh2;
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec, i3x2, 0, i3x2, 0, hval);
  }
  {
    double saved = position[i3x2 + 1];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x2 + 1] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x2 + 1] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x2 + 1] = saved;
    double hval = (e_plus + e_minus - (2.0*e0)) * invh2;
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec, i3x2, 1, i3x2, 1, hval);
  }
  {
    double saved = position[i3x2 + 2];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x2 + 2] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x2 + 2] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x2 + 2] = saved;
    double hval = (e_plus + e_minus - (2.0*e0)) * invh2;
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec, i3x2, 2, i3x2, 2, hval);
  }
  {
    double saved = position[i3x3 + 0];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x3 + 0] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x3 + 0] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x3 + 0] = saved;
    double hval = (e_plus + e_minus - (2.0*e0)) * invh2;
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 0, i3x3, 0, hval);
  }
  {
    double saved = position[i3x3 + 1];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x3 + 1] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x3 + 1] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x3 + 1] = saved;
    double hval = (e_plus + e_minus - (2.0*e0)) * invh2;
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 1, i3x3, 1, hval);
  }
  {
    double saved = position[i3x3 + 2];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x3 + 2] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x3 + 2] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x3 + 2] = saved;
    double hval = (e_plus + e_minus - (2.0*e0)) * invh2;
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 2, i3x3, 2, hval);
  }
  {
    double saved = position[i3x4 + 0];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x4 + 0] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x4 + 0] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x4 + 0] = saved;
    double hval = (e_plus + e_minus - (2.0*e0)) * invh2;
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 0, i3x4, 0, hval);
  }
  {
    double saved = position[i3x4 + 1];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x4 + 1] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x4 + 1] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x4 + 1] = saved;
    double hval = (e_plus + e_minus - (2.0*e0)) * invh2;
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 1, i3x4, 1, hval);
  }
  {
    double saved = position[i3x4 + 2];
    double e_plus = 0.0;
    double e_minus = 0.0;
    position[i3x4 + 2] = saved + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_plus, 0, 0, 0, 0);
    position[i3x4 + 2] = saved - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_minus, 0, 0, 0, 0);
    position[i3x4 + 2] = saved;
    double hval = (e_plus + e_minus - (2.0*e0)) * invh2;
    KernelHessDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 2, i3x4, 2, hval);
  }
  {
    double saved_i = position[i3x1 + 1];
    double saved_j = position[i3x1 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x1 + 1] = saved_i + h; position[i3x1 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_i - h; position[i3x1 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_i; position[i3x1 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x1, 1, i3x1, 0, hval);
  }
  {
    double saved_i = position[i3x1 + 2];
    double saved_j = position[i3x1 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x1 + 2] = saved_i + h; position[i3x1 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_i - h; position[i3x1 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_i; position[i3x1 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x1, 2, i3x1, 0, hval);
  }
  {
    double saved_i = position[i3x1 + 2];
    double saved_j = position[i3x1 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x1 + 2] = saved_i + h; position[i3x1 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_i - h; position[i3x1 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_i; position[i3x1 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x1, 2, i3x1, 1, hval);
  }
  {
    double saved_i = position[i3x2 + 0];
    double saved_j = position[i3x1 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x2 + 0] = saved_i + h; position[i3x1 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_i - h; position[i3x1 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_i; position[i3x1 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x2, 0, i3x1, 0, hval);
  }
  {
    double saved_i = position[i3x2 + 0];
    double saved_j = position[i3x1 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x2 + 0] = saved_i + h; position[i3x1 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_i - h; position[i3x1 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_i; position[i3x1 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x2, 0, i3x1, 1, hval);
  }
  {
    double saved_i = position[i3x2 + 0];
    double saved_j = position[i3x1 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x2 + 0] = saved_i + h; position[i3x1 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_i - h; position[i3x1 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_i; position[i3x1 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x2, 0, i3x1, 2, hval);
  }
  {
    double saved_i = position[i3x2 + 1];
    double saved_j = position[i3x1 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x2 + 1] = saved_i + h; position[i3x1 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_i - h; position[i3x1 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_i; position[i3x1 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x2, 1, i3x1, 0, hval);
  }
  {
    double saved_i = position[i3x2 + 1];
    double saved_j = position[i3x1 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x2 + 1] = saved_i + h; position[i3x1 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_i - h; position[i3x1 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_i; position[i3x1 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x2, 1, i3x1, 1, hval);
  }
  {
    double saved_i = position[i3x2 + 1];
    double saved_j = position[i3x1 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x2 + 1] = saved_i + h; position[i3x1 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_i - h; position[i3x1 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_i; position[i3x1 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x2, 1, i3x1, 2, hval);
  }
  {
    double saved_i = position[i3x2 + 1];
    double saved_j = position[i3x2 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x2 + 1] = saved_i + h; position[i3x2 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_i - h; position[i3x2 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_i; position[i3x2 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x2, 1, i3x2, 0, hval);
  }
  {
    double saved_i = position[i3x2 + 2];
    double saved_j = position[i3x1 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x2 + 2] = saved_i + h; position[i3x1 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_i - h; position[i3x1 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_i; position[i3x1 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x2, 2, i3x1, 0, hval);
  }
  {
    double saved_i = position[i3x2 + 2];
    double saved_j = position[i3x1 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x2 + 2] = saved_i + h; position[i3x1 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_i - h; position[i3x1 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_i; position[i3x1 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x2, 2, i3x1, 1, hval);
  }
  {
    double saved_i = position[i3x2 + 2];
    double saved_j = position[i3x1 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x2 + 2] = saved_i + h; position[i3x1 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_i - h; position[i3x1 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_i; position[i3x1 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x2, 2, i3x1, 2, hval);
  }
  {
    double saved_i = position[i3x2 + 2];
    double saved_j = position[i3x2 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x2 + 2] = saved_i + h; position[i3x2 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_i - h; position[i3x2 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_i; position[i3x2 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x2, 2, i3x2, 0, hval);
  }
  {
    double saved_i = position[i3x2 + 2];
    double saved_j = position[i3x2 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x2 + 2] = saved_i + h; position[i3x2 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_i - h; position[i3x2 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_i; position[i3x2 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x2, 2, i3x2, 1, hval);
  }
  {
    double saved_i = position[i3x3 + 0];
    double saved_j = position[i3x1 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 0] = saved_i + h; position[i3x1 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_i - h; position[i3x1 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_i; position[i3x1 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 0, i3x1, 0, hval);
  }
  {
    double saved_i = position[i3x3 + 0];
    double saved_j = position[i3x1 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 0] = saved_i + h; position[i3x1 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_i - h; position[i3x1 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_i; position[i3x1 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 0, i3x1, 1, hval);
  }
  {
    double saved_i = position[i3x3 + 0];
    double saved_j = position[i3x1 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 0] = saved_i + h; position[i3x1 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_i - h; position[i3x1 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_i; position[i3x1 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 0, i3x1, 2, hval);
  }
  {
    double saved_i = position[i3x3 + 0];
    double saved_j = position[i3x2 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 0] = saved_i + h; position[i3x2 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_i - h; position[i3x2 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_i; position[i3x2 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 0, i3x2, 0, hval);
  }
  {
    double saved_i = position[i3x3 + 0];
    double saved_j = position[i3x2 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 0] = saved_i + h; position[i3x2 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_i - h; position[i3x2 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_i; position[i3x2 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 0, i3x2, 1, hval);
  }
  {
    double saved_i = position[i3x3 + 0];
    double saved_j = position[i3x2 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 0] = saved_i + h; position[i3x2 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_i - h; position[i3x2 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_i; position[i3x2 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 0, i3x2, 2, hval);
  }
  {
    double saved_i = position[i3x3 + 1];
    double saved_j = position[i3x1 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 1] = saved_i + h; position[i3x1 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_i - h; position[i3x1 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_i; position[i3x1 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 1, i3x1, 0, hval);
  }
  {
    double saved_i = position[i3x3 + 1];
    double saved_j = position[i3x1 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 1] = saved_i + h; position[i3x1 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_i - h; position[i3x1 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_i; position[i3x1 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 1, i3x1, 1, hval);
  }
  {
    double saved_i = position[i3x3 + 1];
    double saved_j = position[i3x1 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 1] = saved_i + h; position[i3x1 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_i - h; position[i3x1 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_i; position[i3x1 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 1, i3x1, 2, hval);
  }
  {
    double saved_i = position[i3x3 + 1];
    double saved_j = position[i3x2 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 1] = saved_i + h; position[i3x2 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_i - h; position[i3x2 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_i; position[i3x2 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 1, i3x2, 0, hval);
  }
  {
    double saved_i = position[i3x3 + 1];
    double saved_j = position[i3x2 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 1] = saved_i + h; position[i3x2 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_i - h; position[i3x2 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_i; position[i3x2 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 1, i3x2, 1, hval);
  }
  {
    double saved_i = position[i3x3 + 1];
    double saved_j = position[i3x2 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 1] = saved_i + h; position[i3x2 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_i - h; position[i3x2 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_i; position[i3x2 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 1, i3x2, 2, hval);
  }
  {
    double saved_i = position[i3x3 + 1];
    double saved_j = position[i3x3 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 1] = saved_i + h; position[i3x3 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_i - h; position[i3x3 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_i; position[i3x3 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 1, i3x3, 0, hval);
  }
  {
    double saved_i = position[i3x3 + 2];
    double saved_j = position[i3x1 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 2] = saved_i + h; position[i3x1 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i - h; position[i3x1 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i; position[i3x1 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 2, i3x1, 0, hval);
  }
  {
    double saved_i = position[i3x3 + 2];
    double saved_j = position[i3x1 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 2] = saved_i + h; position[i3x1 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i - h; position[i3x1 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i; position[i3x1 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 2, i3x1, 1, hval);
  }
  {
    double saved_i = position[i3x3 + 2];
    double saved_j = position[i3x1 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 2] = saved_i + h; position[i3x1 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i - h; position[i3x1 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i; position[i3x1 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 2, i3x1, 2, hval);
  }
  {
    double saved_i = position[i3x3 + 2];
    double saved_j = position[i3x2 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 2] = saved_i + h; position[i3x2 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i - h; position[i3x2 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i; position[i3x2 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 2, i3x2, 0, hval);
  }
  {
    double saved_i = position[i3x3 + 2];
    double saved_j = position[i3x2 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 2] = saved_i + h; position[i3x2 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i - h; position[i3x2 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i; position[i3x2 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 2, i3x2, 1, hval);
  }
  {
    double saved_i = position[i3x3 + 2];
    double saved_j = position[i3x2 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 2] = saved_i + h; position[i3x2 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i - h; position[i3x2 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i; position[i3x2 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 2, i3x2, 2, hval);
  }
  {
    double saved_i = position[i3x3 + 2];
    double saved_j = position[i3x3 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 2] = saved_i + h; position[i3x3 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i - h; position[i3x3 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i; position[i3x3 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 2, i3x3, 0, hval);
  }
  {
    double saved_i = position[i3x3 + 2];
    double saved_j = position[i3x3 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x3 + 2] = saved_i + h; position[i3x3 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i - h; position[i3x3 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_i; position[i3x3 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x3, 2, i3x3, 1, hval);
  }
  {
    double saved_i = position[i3x4 + 0];
    double saved_j = position[i3x1 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 0] = saved_i + h; position[i3x1 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i - h; position[i3x1 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i; position[i3x1 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 0, i3x1, 0, hval);
  }
  {
    double saved_i = position[i3x4 + 0];
    double saved_j = position[i3x1 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 0] = saved_i + h; position[i3x1 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i - h; position[i3x1 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i; position[i3x1 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 0, i3x1, 1, hval);
  }
  {
    double saved_i = position[i3x4 + 0];
    double saved_j = position[i3x1 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 0] = saved_i + h; position[i3x1 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i - h; position[i3x1 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i; position[i3x1 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 0, i3x1, 2, hval);
  }
  {
    double saved_i = position[i3x4 + 0];
    double saved_j = position[i3x2 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 0] = saved_i + h; position[i3x2 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i - h; position[i3x2 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i; position[i3x2 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 0, i3x2, 0, hval);
  }
  {
    double saved_i = position[i3x4 + 0];
    double saved_j = position[i3x2 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 0] = saved_i + h; position[i3x2 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i - h; position[i3x2 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i; position[i3x2 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 0, i3x2, 1, hval);
  }
  {
    double saved_i = position[i3x4 + 0];
    double saved_j = position[i3x2 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 0] = saved_i + h; position[i3x2 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i - h; position[i3x2 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i; position[i3x2 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 0, i3x2, 2, hval);
  }
  {
    double saved_i = position[i3x4 + 0];
    double saved_j = position[i3x3 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 0] = saved_i + h; position[i3x3 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i - h; position[i3x3 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i; position[i3x3 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 0, i3x3, 0, hval);
  }
  {
    double saved_i = position[i3x4 + 0];
    double saved_j = position[i3x3 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 0] = saved_i + h; position[i3x3 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i - h; position[i3x3 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i; position[i3x3 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 0, i3x3, 1, hval);
  }
  {
    double saved_i = position[i3x4 + 0];
    double saved_j = position[i3x3 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 0] = saved_i + h; position[i3x3 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i - h; position[i3x3 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_i; position[i3x3 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 0, i3x3, 2, hval);
  }
  {
    double saved_i = position[i3x4 + 1];
    double saved_j = position[i3x1 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 1] = saved_i + h; position[i3x1 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i - h; position[i3x1 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i; position[i3x1 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 1, i3x1, 0, hval);
  }
  {
    double saved_i = position[i3x4 + 1];
    double saved_j = position[i3x1 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 1] = saved_i + h; position[i3x1 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i - h; position[i3x1 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i; position[i3x1 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 1, i3x1, 1, hval);
  }
  {
    double saved_i = position[i3x4 + 1];
    double saved_j = position[i3x1 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 1] = saved_i + h; position[i3x1 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i - h; position[i3x1 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i; position[i3x1 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 1, i3x1, 2, hval);
  }
  {
    double saved_i = position[i3x4 + 1];
    double saved_j = position[i3x2 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 1] = saved_i + h; position[i3x2 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i - h; position[i3x2 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i; position[i3x2 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 1, i3x2, 0, hval);
  }
  {
    double saved_i = position[i3x4 + 1];
    double saved_j = position[i3x2 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 1] = saved_i + h; position[i3x2 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i - h; position[i3x2 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i; position[i3x2 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 1, i3x2, 1, hval);
  }
  {
    double saved_i = position[i3x4 + 1];
    double saved_j = position[i3x2 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 1] = saved_i + h; position[i3x2 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i - h; position[i3x2 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i; position[i3x2 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 1, i3x2, 2, hval);
  }
  {
    double saved_i = position[i3x4 + 1];
    double saved_j = position[i3x3 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 1] = saved_i + h; position[i3x3 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i - h; position[i3x3 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i; position[i3x3 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 1, i3x3, 0, hval);
  }
  {
    double saved_i = position[i3x4 + 1];
    double saved_j = position[i3x3 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 1] = saved_i + h; position[i3x3 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i - h; position[i3x3 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i; position[i3x3 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 1, i3x3, 1, hval);
  }
  {
    double saved_i = position[i3x4 + 1];
    double saved_j = position[i3x3 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 1] = saved_i + h; position[i3x3 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i - h; position[i3x3 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i; position[i3x3 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 1, i3x3, 2, hval);
  }
  {
    double saved_i = position[i3x4 + 1];
    double saved_j = position[i3x4 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 1] = saved_i + h; position[i3x4 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i - h; position[i3x4 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_i; position[i3x4 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 1, i3x4, 0, hval);
  }
  {
    double saved_i = position[i3x4 + 2];
    double saved_j = position[i3x1 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 2] = saved_i + h; position[i3x1 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i - h; position[i3x1 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i; position[i3x1 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 2, i3x1, 0, hval);
  }
  {
    double saved_i = position[i3x4 + 2];
    double saved_j = position[i3x1 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 2] = saved_i + h; position[i3x1 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i - h; position[i3x1 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i; position[i3x1 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 2, i3x1, 1, hval);
  }
  {
    double saved_i = position[i3x4 + 2];
    double saved_j = position[i3x1 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 2] = saved_i + h; position[i3x1 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i - h; position[i3x1 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x1 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i; position[i3x1 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 2, i3x1, 2, hval);
  }
  {
    double saved_i = position[i3x4 + 2];
    double saved_j = position[i3x2 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 2] = saved_i + h; position[i3x2 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i - h; position[i3x2 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i; position[i3x2 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 2, i3x2, 0, hval);
  }
  {
    double saved_i = position[i3x4 + 2];
    double saved_j = position[i3x2 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 2] = saved_i + h; position[i3x2 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i - h; position[i3x2 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i; position[i3x2 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 2, i3x2, 1, hval);
  }
  {
    double saved_i = position[i3x4 + 2];
    double saved_j = position[i3x2 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 2] = saved_i + h; position[i3x2 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i - h; position[i3x2 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x2 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i; position[i3x2 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 2, i3x2, 2, hval);
  }
  {
    double saved_i = position[i3x4 + 2];
    double saved_j = position[i3x3 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 2] = saved_i + h; position[i3x3 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i - h; position[i3x3 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x3 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i; position[i3x3 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 2, i3x3, 0, hval);
  }
  {
    double saved_i = position[i3x4 + 2];
    double saved_j = position[i3x3 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 2] = saved_i + h; position[i3x3 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i - h; position[i3x3 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x3 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i; position[i3x3 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 2, i3x3, 1, hval);
  }
  {
    double saved_i = position[i3x4 + 2];
    double saved_j = position[i3x3 + 2];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 2] = saved_i + h; position[i3x3 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i - h; position[i3x3 + 2] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x3 + 2] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i; position[i3x3 + 2] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 2, i3x3, 2, hval);
  }
  {
    double saved_i = position[i3x4 + 2];
    double saved_j = position[i3x4 + 0];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 2] = saved_i + h; position[i3x4 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i - h; position[i3x4 + 0] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x4 + 0] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i; position[i3x4 + 0] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 2, i3x4, 0, hval);
  }
  {
    double saved_i = position[i3x4 + 2];
    double saved_j = position[i3x4 + 1];
    double e_pp = 0.0;
    double e_pm = 0.0;
    double e_mp = 0.0;
    double e_mm = 0.0;
    position[i3x4 + 2] = saved_i + h; position[i3x4 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pp, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_pm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i - h; position[i3x4 + 1] = saved_j + h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mp, 0, 0, 0, 0);
    position[i3x4 + 1] = saved_j - h;
    dihedral_restraint_energy(kdh, phi0, i3x1, i3x2, i3x3, i3x4, position, &e_mm, 0, 0, 0, 0);
    position[i3x4 + 2] = saved_i; position[i3x4 + 1] = saved_j;
    double hval = (e_pp - e_pm - e_mp + e_mm) * (0.25*invh2);
    KernelHessOffDiagAcc( PositionSize, hessian, dvec, hdvec, i3x4, 2, i3x4, 1, hval);
  }
}

